<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HelenA QuantumRaid">
    <meta name="theme-color" content="#3b82f6">
    <title>{% block title %}HelenA QuantumRaid Bot - Simple Config{% endblock %}</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: white;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-color: #60a5fa;
            --success-color: #34d399;
            --danger-color: #f87171;
            --warning-color: #fbbf24;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundFloat 20s ease-in-out infinite alternate;
        }

        @keyframes backgroundFloat {
            0% {
                transform: translateY(0px) rotate(0deg);
            }

            100% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .header {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow:
                0 8px 32px rgba(31, 38, 135, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            animation: slideInCard 0.6s ease-out forwards;
            opacity: 0;
        }

        .config-section:hover {
            transform: translateY(-4px);
            box-shadow:
                0 16px 64px rgba(31, 38, 135, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.3);
        }

        @keyframes slideInCard {
            0% {
                transform: translateY(30px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monster-card {
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .monster-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .monster-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .monster-card:hover::before {
            left: 100%;
        }

        .monster-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .monster-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .monster-name {
            font-weight: 500;
            color: #1e293b;
            font-size: 16px;
        }

        .level-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .input-field {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .troops-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .troops-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .troops-title {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .dropdown-field {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            min-width: 120px;
        }

        .troop-item {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .troop-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .troop-item:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .troop-item:hover::before {
            left: 100%;
        }

        .troop-select {
            flex: 2;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            transition: all 0.3s ease;
        }

        .troop-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .troop-amount,
        .troop-amount-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            background: white;
            transition: all 0.3s ease;
        }

        .troop-amount:focus,
        .troop-amount-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-enabled {
            background-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .status-disabled {
            background-color: #6b7280;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.2);
        }

        .fixed-amounts-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .fixed-amounts-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        /* Add staggered animations for config sections */
        .config-section:nth-child(1) {
            animation-delay: 0.1s;
        }

        .config-section:nth-child(2) {
            animation-delay: 0.2s;
        }

        .config-section:nth-child(3) {
            animation-delay: 0.3s;
        }

        .config-section:nth-child(4) {
            animation-delay: 0.4s;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .distance-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .distance-input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .unit-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .save-section {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: white;
            color: #1e293b;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .toggle-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #3b82f6;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }



        .job-item,
        .thread-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .job-name,
        .thread-name {
            font-weight: 500;
            color: #374151;
        }

        .job-description,
        .thread-description {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 16px;
            }

            .header>div {
                flex-direction: column;
                align-items: stretch !important;
                gap: 16px;
            }

            .header>div>div:last-child {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                overflow-x: auto;
            }

            .header select,
            .header button {
                width: 100%;
                margin-bottom: 8px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .level-inputs {
                grid-template-columns: 1fr;
            }

            .troop-item {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .distance-section {
                flex-direction: column;
                align-items: stretch;
            }



            .job-item,
            .thread-item {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .tabs {
                flex-wrap: wrap;
                gap: 4px;
            }

            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }

            .config-section {
                padding: 20px;
                margin-bottom: 20px;
            }

            .monster-card {
                padding: 16px;
            }

            .save-section {
                flex-direction: column;
                gap: 8px;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }

        .notification.info {
            background-color: #3498db;
        }

        .notification.warning {
            background-color: #f39c12;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .notification.success {
            background-color: #27ae60;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile touch improvements */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 16px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            /* Improve touch targets */
            .monster-checkbox, .troop-select, input[type="number"], input[type="text"] {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Better tab scrolling on mobile */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding-bottom: 4px;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                flex: 0 0 auto;
                white-space: nowrap;
            }
            
            /* Optimize config sections for mobile */
            .config-section {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            /* Better modal sizing */
            .modal-body {
                max-height: 70vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Improve form layouts on mobile */
            .input-group {
                margin-bottom: 16px;
            }
            
            /* Monster cards responsive */
            .monster-card {
                margin-bottom: 12px;
                padding: 12px;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }
            
            .header {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .config-section {
                padding: 12px;
            }
            
            .tab {
                min-width: 100px;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            .monster-card {
                padding: 8px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 14px;
            }
        }

            .input-field,
            .dropdown-field {
                min-height: 44px;
                font-size: 16px;
            }

            .toggle-switch {
                width: 52px;
                height: 28px;
            }

            .toggle-slider:before {
                height: 22px;
                width: 22px;
                left: 3px;
                bottom: 3px;
            }

            input:checked+.toggle-slider:before {
                transform: translateX(24px);
            }

            .monster-checkbox {
                width: 22px;
                height: 22px;
            }

            .tab {
                min-height: 44px;
                padding: 12px 16px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-cog"></i> Bot Configuration</h1>
                    <p>Configure your bot settings with a simple and clean interface</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode"
                        style="width: 44px; height: 24px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; padding: 2px;">
                        <div class="theme-toggle-slider"
                            style="width: 20px; height: 20px; background: var(--accent-color); border-radius: 50%; transition: transform 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;">
                            <i class="fas fa-moon" id="theme-icon"></i>
                        </div>
                    </div>
                    <a href="/" class="nav-link"
                        style="color: var(--text-secondary); text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; border: 1px solid var(--border-color);">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    <label for="config-file-select" style="font-weight: 500; color: #374151;">Config File:</label>
                    <select id="config-file-select" class="dropdown-field">
                        <option value="">Select a config file</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadSelectedConfig()" id="load-config-btn" disabled>
                        <i class="fas fa-download"></i> Load
                    </button>
                    <button class="btn btn-secondary" onclick="showCreateConfigModal()">
                        <i class="fas fa-plus"></i> New Config
                    </button>
                    <button class="btn btn-secondary" onclick="showRenameConfigModal()" id="rename-config-btn" disabled>
                        <i class="fas fa-edit"></i> Rename
                    </button>
                    <button class="btn btn-danger" onclick="deleteCurrentConfig()" id="delete-config-btn" disabled>
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- Config Type Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('rally-join')">
                <i class="fas fa-users"></i> Rally Join
            </button>
            <button class="tab" onclick="switchTab('rally-start')">
                <i class="fas fa-flag"></i> Rally Start
            </button>
            <button class="tab" onclick="switchTab('monster-attack')">
                <i class="fas fa-dragon"></i> Monster Attack
            </button>
            <button class="tab" onclick="switchTab('socf-objects')">
                <i class="fas fa-search"></i> Object Scanning
            </button>
            <button class="tab" onclick="switchTab('buff-management')">
                <i class="fas fa-magic"></i> Buff Management
            </button>
            <button class="tab" onclick="switchTab('alliance-activities')">
                <i class="fas fa-handshake"></i> Alliance Activities
            </button>
            <button class="tab" onclick="switchTab('skills')">
                <i class="fas fa-bolt"></i> Skills
            </button>
            <button class="tab" onclick="switchTab('treasure')">
                <i class="fas fa-gem"></i> Treasure
            </button>
            <button class="tab" onclick="switchTab('dsavip')">
                <i class="fas fa-crown"></i> DSA VIP
            </button>
            <button class="tab" onclick="switchTab('settings')">
                <i class="fas fa-cog"></i> Jobs & Threads
            </button>
        </div>

        <!-- Rally Join Configuration -->
        <div id="rally-join" class="tab-content active">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-users"></i>
                    Rally Join Configuration
                </h2>

                <!-- Enable/Disable Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="rally-join-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Rally Join</span>
                </div>

                <!-- Rally Join Skin Change -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="rally-join-skin-change-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Skin Change</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Change skin before joining rallies
                    </small>
                </div>

                <div class="distance-section">
                    <span class="troops-title">Skin NFT ID</span>
                    <input type="text" id="rally-join-skin-item-id" class="distance-input" value="" placeholder="e.g., 1883735">
                    <span class="unit-label">NFT id</span>
                </div>

                <!-- Number of Marches -->
                <div class="distance-section">
                    <span class="troops-title">Number of Marches</span>
                    <input type="number" id="rally-join-marches" class="distance-input" value="8" min="1" max="10">
                    <span class="unit-label">marches</span>
                </div>

                <!-- Monster Cards -->
                <div id="rally-join-monsters">
                    <!-- Monster cards will be loaded here -->
                </div>

                <!-- Max Rally Distance -->
                <div class="distance-section">
                    <span class="troops-title">Max Rally Distance</span>
                    <input type="number" id="rally-join-distance" class="distance-input" value="500" min="1">
                    <span class="unit-label">km</span>
                </div>

                <!-- Add New Monster -->
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
                    <select id="rally-join-monster-select" class="dropdown-field" style="flex: 1;">
                        <option value="">Select a monster to add</option>
                        <option value="20200201_Deathkar">Deathkar</option>
                        <option value="20200202_Green Dragon">Green Dragon</option>
                        <option value="20200203_Red Dragon">Red Dragon</option>
                        <option value="20200204_Gold Dragon">Gold Dragon</option>
                        <option value="20200205_Magdar">Magdar</option>
                        <option value="20200206_Pantagruel">Pantagruel</option>
                        <option value="20200207_Gargantua">Gargantua</option>
                        <option value="20200101_Orc">Orc</option>
                        <option value="20200102_Skeleton">Skeleton</option>
                        <option value="20200103_Golem">Golem</option>
                        <option value="20200104_Treasure Goblin">Treasure Goblin</option>
                        <option value="20700405_Ogre">Ogre</option>
                        <option value="20700406_Wolf">Wolf</option>
                        <option value="20700407_Cyclops">Cyclops</option>
                        <option value="20700506_Spartoi">Spartoi</option>
                        <option value="20800401_BF Orc">BF Orc</option>
                        <option value="20800402_BF Skeleton">BF Skeleton</option>
                        <option value="20800403_BF Golem">BF Golem</option>
                        <option value="20800404_BF Treasure Goblin">BF Treasure Goblin</option>
                    </select>
                    <button class="btn btn-primary" onclick="addSelectedMonster('rally-join')">
                        <i class="fas fa-plus"></i>
                        Add Monster
                    </button>
                </div>

                <!-- Save Section -->
                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('rally-join')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Rally Start Configuration -->
        <div id="rally-start" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-flag"></i>
                    Rally Start Configuration
                </h2>

                <!-- Enable/Disable Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="rally-start-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Rally Start</span>
                </div>

                <!-- Rally Start Skin Change -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="rally-start-skin-change-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Skin Change</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Change skin before starting rallies
                    </small>
                </div>

                <div class="distance-section">
                    <span class="troops-title">Skin NFT ID</span>
                    <input type="text" id="rally-start-skin-item-id" class="distance-input" value="" placeholder="e.g., 1883734">
                    <span class="unit-label">NFT id</span>
                </div>

                <!-- Number of Marches -->
                <div class="distance-section">
                    <span class="troops-title">Number of Marches</span>
                    <input type="number" id="rally-start-marches" class="distance-input" value="6" min="1" max="10">
                    <span class="unit-label">marches</span>
                </div>

                <div id="rally-start-monsters">
                    <!-- Monster cards will be loaded here -->
                </div>

                <!-- Max Rally Distance -->
                <div class="distance-section">
                    <span class="troops-title">Max Rally Distance</span>
                    <input type="number" id="rally-start-distance" class="distance-input" value="500" min="1">
                    <span class="unit-label">km</span>
                </div>

                <!-- Add New Monster -->
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
                    <select id="rally-start-monster-select" class="dropdown-field" style="flex: 1;">
                        <option value="">Select a monster to add</option>
                        <option value="20200201_Deathkar">Deathkar</option>
                        <option value="20200202_Green Dragon">Green Dragon</option>
                        <option value="20200203_Red Dragon">Red Dragon</option>
                        <option value="20200204_Gold Dragon">Gold Dragon</option>
                        <option value="20200205_Magdar">Magdar</option>
                        <option value="20200206_Pantagruel">Pantagruel</option>
                        <option value="20200207_Gargantua">Gargantua</option>
                        <option value="20200101_Orc">Orc</option>
                        <option value="20200102_Skeleton">Skeleton</option>
                        <option value="20200103_Golem">Golem</option>
                        <option value="20200104_Treasure Goblin">Treasure Goblin</option>
                        <option value="20700405_Ogre">Ogre</option>
                        <option value="20700406_Wolf">Wolf</option>
                        <option value="20700407_Cyclops">Cyclops</option>
                        <option value="20700506_Spartoi">Spartoi</option>
                        <option value="20800401_BF Orc">BF Orc</option>
                        <option value="20800402_BF Skeleton">BF Skeleton</option>
                        <option value="20800403_BF Golem">BF Golem</option>
                        <option value="20800404_BF Treasure Goblin">BF Treasure Goblin</option>
                    </select>
                    <button class="btn btn-primary" onclick="addSelectedMonster('rally-start')">
                        <i class="fas fa-plus"></i>
                        Add Monster
                    </button>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('rally-start')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Monster Attack Configuration -->
        <div id="monster-attack" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-dragon"></i>
                    Monster Attack Configuration
                </h2>

                <!-- Enable/Disable Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="monster-attack-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Monster Attack</span>
                </div>

                <div id="monster-attack-monsters">
                    <!-- Monster cards will be loaded here -->
                </div>

                <!-- Max Attack Distance -->
                <div class="distance-section">
                    <div class="toggle-section">
                        <label class="toggle-switch">
                            <input type="checkbox" id="monster-distance-check-enabled">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="troops-title">Enable Distance Check</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px;">
                        <span class="troops-title">Max Attack Distance</span>
                        <input type="number" id="monster-attack-distance" class="distance-input" value="200" min="1">
                        <span class="unit-label">km</span>
                    </div>
                </div>

                <!-- Add New Monster -->
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
                    <select id="monster-attack-monster-select" class="dropdown-field" style="flex: 1;">
                        <option value="">Select a monster to add</option>
                        <option value="20200101_Orc">Orc</option>
                        <option value="20200102_Skeleton">Skeleton</option>
                        <option value="20200103_Golem">Golem</option>
                        <option value="20200104_Treasure Goblin">Treasure Goblin</option>
                        <option value="20700405_Ogre">Ogre</option>
                        <option value="20700406_Wolf">Wolf</option>
                        <option value="20700407_Cyclops">Cyclops</option>
                    </select>
                    <button class="btn btn-primary" onclick="addSelectedMonster('monster-attack')">
                        <i class="fas fa-plus"></i>
                        Add Monster
                    </button>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('monster-attack')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- SOCF Objects Configuration -->
        <div id="socf-objects" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-search"></i>
                    Object Scanning Configuration
                </h2>

                <!-- Enable/Disable Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="socf-objects-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Object Scanning</span>
                </div>

                <!-- Enable Gathering Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="socf-gathering-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Gathering</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Automatically gather resources when found during object scanning
                    </small>
                </div>

                <!-- Object Scanning Skin Change -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="socf-objects-skin-change-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Skin Change</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Change skin during object scanning activities
                    </small>
                </div>

                <div class="distance-section">
                    <span class="troops-title">Skin NFT ID</span>
                    <input type="text" id="socf-objects-skin-item-id" class="distance-input" value="" placeholder="e.g., 1807697">
                    <span class="unit-label">NFT id</span>
                </div>

                <div id="socf-objects-list">
                    <!-- Object cards will be loaded here -->
                </div>

                <!-- Max Marches -->
                <div class="distance-section">
                    <span class="troops-title">Max Marches</span>
                    <input type="number" id="socf-objects-max-marches" class="distance-input" value="10" min="1"
                        max="20">
                    <span class="unit-label">marches</span>
                </div>

                <!-- Scan Radius -->
                <div class="distance-section">
                    <span class="troops-title">Scan Radius</span>
                    <input type="number" id="socf-objects-radius" class="distance-input" value="16" min="1" max="50"
                        disabled readonly>
                    <span class="unit-label">tiles</span>
                </div>

                <!-- Area Restrictions -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="area-restrictions-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Area Restrictions</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Limit gathering and monster attacks to specific coordinate areas
                    </small>
                </div>

                <div id="area-restrictions-container" style="margin-top: 16px; display: none;">
                    <div id="area-restrictions-list">
                        <!-- Area restriction cards will be loaded here -->
                    </div>
                    
                    <!-- Add New Area -->
                    <div style="margin-top: 16px;">
                        <button class="btn btn-secondary" onclick="addAreaRestriction()">
                            <i class="fas fa-plus"></i>
                            Add New Area
                        </button>
                    </div>
                </div>

                <!-- Add New Object -->
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
                    <select id="socf-object-select" class="dropdown-field" style="flex: 1;">
                        <option value="">Select an object to add</option>
                        <option value="20100105_Crystal Mine">Crystal Mine</option>
                        <option value="20100106_Dragon Soul Cavern">Dragon Soul Cavern</option>
                        <option value="20100101_Farm">Farm</option>
                        <option value="20100102_Gold Mine">Gold Mine</option>
                        <option value="20100103_Lumber Camp">Lumber Camp</option>
                        <option value="20100104_Quarry">Quarry</option>
                        <option value="20200103_Golem">Golem</option>
                        <option value="20200101_Orc">Orc</option>
                        <option value="20200102_Skeleton">Skeleton</option>
                        <option value="20200201_Deathkar">Deathkar</option>
                        <option value="20200104_Treasure Goblin">Treasure Goblin</option>
                    </select>
                    <button class="btn btn-primary" onclick="addSelectedSocfObject()">
                        <i class="fas fa-plus"></i>
                        Add Object
                    </button>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('socf-objects')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Buff Management Configuration -->
        <div id="buff-management" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-magic"></i>
                    Production Boost Management
                </h2>

                <!-- Enable/Disable Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="buff-management-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Automatic Production Boost Management</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Automatically activates production boosts when they expire based on duration and priority settings
                    </small>
                </div>

                <div class="tabs" style="margin-top: 20px;">
                    <button class="tab active" onclick="switchBuffTab('short-duration')">
                        <i class="fas fa-clock"></i> Short (≤1h)
                    </button>
                    <button class="tab" onclick="switchBuffTab('medium-duration')">
                        <i class="fas fa-hourglass-half"></i> Medium (1-24h)
                    </button>
                    <button class="tab" onclick="switchBuffTab('long-duration')">
                        <i class="fas fa-hourglass-end"></i> Long (>24h)
                    </button>
                </div>

                <div id="short-duration" class="tab-content active" style="margin-top: 20px;">
                    <div id="short-duration-list"></div>
                </div>
                
                <div id="medium-duration" class="tab-content" style="margin-top: 20px;">
                    <div id="medium-duration-list"></div>
                </div>
                
                <div id="long-duration" class="tab-content" style="margin-top: 20px;">
                    <div id="long-duration-list"></div>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('buff-management')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Alliance Activities Configuration -->
        <div id="alliance-activities" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-handshake"></i>
                    Alliance Activities Configuration
                </h2>
                <div style="color: #64748b; font-size: 14px; margin-bottom: 30px;">
                    Configure each alliance activity to run on its own thread with custom intervals
                </div>

                <!-- Alliance Help All -->
                <div class="monster-card">
                    <div class="monster-header">
                        <i class="fas fa-hands-helping" style="color: #10b981;"></i>
                        <span class="monster-name">Alliance Help All</span>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="alliance-help-enabled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                        Automatically help alliance members with their buildings and research
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #374151; font-weight: 500;">Interval (minutes):</span>
                        <input type="number" id="alliance-help-interval" value="5" min="1" max="1440" 
                               style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <small style="color: #64748b;">How often to check for help requests</small>
                    </div>
                </div>

                <!-- Alliance Gift Claim -->
                <div class="monster-card">
                    <div class="monster-header">
                        <i class="fas fa-gift" style="color: #f59e0b;"></i>
                        <span class="monster-name">Alliance Gift Claim</span>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="alliance-gift-enabled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                        Automatically claim alliance gifts from other members
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #374151; font-weight: 500;">Interval (minutes):</span>
                        <input type="number" id="alliance-gift-interval" value="30" min="5" max="1440" 
                               style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <small style="color: #64748b;">How often to check for new gifts</small>
                    </div>
                </div>

                <!-- Alliance Research Donate -->
                <div class="monster-card">
                    <div class="monster-header">
                        <i class="fas fa-flask" style="color: #8b5cf6;"></i>
                        <span class="monster-name">Alliance Research Donate</span>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="alliance-research-enabled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                        Automatically donate resources to alliance research
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #374151; font-weight: 500;">Interval (minutes):</span>
                        <input type="number" id="alliance-research-interval" value="60" min="10" max="1440" 
                               style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <small style="color: #64748b;">How often to donate to research</small>
                    </div>
                </div>

                <!-- Alliance Shop Auto-Buy -->
                <div class="monster-card">
                    <div class="monster-header">
                        <i class="fas fa-shopping-cart" style="color: #ef4444;"></i>
                        <span class="monster-name">Alliance Shop Auto-Buy</span>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="alliance-shop-enabled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                        Automatically purchase items from alliance shop (configured in Alliance Shop tab)
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #374151; font-weight: 500;">Interval (minutes):</span>
                        <input type="number" id="alliance-shop-interval" value="120" min="30" max="1440" 
                               style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <small style="color: #64748b;">How often to check shop for items</small>
                    </div>

                    <!-- Advanced Alliance Shop Configuration -->
                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #ef4444;">
                        <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">
                            <i class="fas fa-cog"></i> Advanced Shop Configuration
                        </h4>
                        <div style="margin-bottom: 12px;">
                            <button class="btn btn-secondary" onclick="loadAllianceShopItems()" style="font-size: 12px; padding: 6px 12px;">
                                <i class="fas fa-refresh"></i> Load Available Items
                            </button>
                            <button class="btn btn-accent" onclick="addShopItem()" style="font-size: 12px; padding: 6px 12px; margin-left: 8px;">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        <div id="alliance-shop-items-list" style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
                            <!-- Shop items will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Caravan Auto-Buy -->
                <div class="monster-card">
                    <div class="monster-header">
                        <i class="fas fa-truck" style="color: #10b981;"></i>
                        <span class="monster-name">Caravan Auto-Buy</span>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="caravan-auto-buy-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                        Automatically purchase items from visiting caravans
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #374151; font-weight: 500;">Interval (minutes):</span>
                        <input type="number" id="caravan-interval" value="180" min="30" max="1440" 
                               style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <small style="color: #64748b;">How often to check for caravans</small>
                    </div>

                    <!-- Advanced Caravan Configuration -->
                    <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                        <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">
                            <i class="fas fa-cog"></i> Advanced Caravan Configuration
                        </h4>
                        <div style="margin-bottom: 12px;">
                            <button class="btn btn-secondary" onclick="loadCaravanItems()" style="font-size: 12px; padding: 6px 12px;">
                                <i class="fas fa-refresh"></i> Load Available Items
                            </button>
                            <button class="btn btn-accent" onclick="addCaravanItem()" style="font-size: 12px; padding: 6px 12px; margin-left: 8px;">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        <div id="caravan-items-list" style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; background: white;">
                            <!-- Caravan items will be loaded here -->
                        </div>
                    </div>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('alliance-activities')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Skills Configuration -->
        <div id="skills" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-bolt"></i>
                    Skills Configuration
                </h2>

                <!-- Enable Skills Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="skills-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Skills</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Automatically use skills during gameplay
                    </small>
                </div>

                <!-- Enable Two-Skin Workflow Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="skills-skin-change-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Two-Skin Workflow</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Change to Skin 1 → Change treasure page → Activate "Increase Resource Production" + "Instant Harvest" → Wait 2 mins → Change to Skin 2 and Change treasure page again
                    </small>
                </div>

                <!-- First Row: First Skin ID and First Treasure Page -->
                <div style="display: flex; gap: 20px; margin: 20px 0; align-items: center;">
                    <div style="flex: 1;">
                        <span class="troops-title">First Skin ID</span>
                        <input type="text" id="skills-skin-item-id" class="distance-input" value="" placeholder="67b0bf9d6d" style="width: 100%;">
                        <small style="color: #64748b; font-size: 11px;">first skin id</small>
                    </div>
                    <div style="flex: 1;">
                        <span class="troops-title">First Treasure Page</span>
                        <select id="skills-treasure-page-1" class="dropdown-field" style="width: 100%;">
                            <option value="0">Page 0</option>
                            <option value="1">Page 1</option>
                            <option value="2">Page 2</option>
                            <option value="3" selected>Page 3</option>
                        </select>
                        <small style="color: #64748b; font-size: 11px;">treasure page 1</small>
                    </div>
                </div>

                <!-- Second Row: Second Skin ID and Second Treasure Page -->
                <div style="display: flex; gap: 20px; margin: 20px 0; align-items: center;">
                    <div style="flex: 1;">
                        <span class="troops-title">Second Skin ID</span>
                        <input type="text" id="skills-skin-item-id-2" class="distance-input" value="" placeholder="1557544" style="width: 100%;">
                        <small style="color: #64748b; font-size: 11px;">second skin id</small>
                    </div>
                    <div style="flex: 1;">
                        <span class="troops-title">Second Treasure Page</span>
                        <select id="skills-treasure-page-2" class="dropdown-field" style="width: 100%;">
                            <option value="0">Page 0</option>
                            <option value="1" selected>Page 1</option>
                            <option value="2">Page 2</option>
                            <option value="3">Page 3</option>
                        </select>
                        <small style="color: #64748b; font-size: 11px;">treasure page 2</small>
                    </div>
                </div>

                <!-- Individual Skills Section -->
                <div style="margin-top: 30px;">
                    <!-- Instant Harvest -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                        <div>
                            <div style="font-weight: 500; color: #1e293b;">Instant Harvest</div>
                            <small style="color: #64748b; font-size: 12px;">Code: 10001 - Auto-activate when available</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="skill-10001-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Accelerated Gathering -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
                        <div>
                            <div style="font-weight: 500; color: #1e293b;">Accelerated Gathering</div>
                            <small style="color: #64748b; font-size: 12px;">Code: 10002 - Auto-activate when available</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="skill-10002-enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('skills')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Treasure Configuration -->
        <div id="treasure" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-gem"></i>
                    Treasure Configuration
                </h2>

                <!-- Enable/Disable Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="treasure-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Treasure Hunt</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Automatically hunt for treasures
                    </small>
                </div>

                <!-- Treasure Page Selection -->
                <div class="distance-section">
                    <span class="troops-title">Treasure Page</span>
                    <select id="treasure-page" class="dropdown-field">
                        <option value="0">Page 0</option>
                        <option value="1">Page 1</option>
                        <option value="2">Page 2</option>
                        <option value="3">Page 3</option>
                    </select>
                    <span class="unit-label">treasure page</span>
                </div>

                <!-- Treasure Skin Change -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="treasure-skin-change-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable Skin Change</span>
                </div>

                <div class="distance-section">
                    <span class="troops-title">Skin NFT ID</span>
                    <input type="text" id="treasure-skin-item-id" class="distance-input" value="" placeholder="e.g., 1726795">
                    <span class="unit-label">NFT id</span>
                </div>

                <div class="distance-section">
                    <span class="troops-title">Skin Change Interval</span>
                    <input type="number" id="treasure-skin-change-interval" class="distance-input" value="60" min="1">
                    <span class="unit-label">minutes</span>
                </div>


                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('treasure')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- DSA VIP Configuration -->
        <div id="dsavip" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-crown"></i>
                    DSA VIP Configuration
                </h2>

                <!-- DSA VIP Chest Claim Toggle -->
                <div class="toggle-section">
                    <label class="toggle-switch">
                        <input type="checkbox" id="dsavip-chest-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="troops-title">Enable DSA VIP Chest Claim</span>
                    <small style="display: block; color: #64748b; margin-top: 5px;">
                        Automatically claim DSA VIP daily chest rewards
                    </small>
                </div>

                <!-- DSA VIP Chest Claim Job Configuration -->
                <div class="job-item">
                    <div>
                        <div class="job-name">DSA VIP Chest Claim Job</div>
                        <div class="job-description">Periodic job to claim DSA VIP chest rewards</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dsavip-job-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('dsavip')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings (Jobs & Threads) Configuration -->
        <div id="settings" class="tab-content">
            <div class="config-section">
                <h2 class="section-title">
                    <i class="fas fa-cog"></i>
                    Jobs & Threads Configuration
                </h2>

                <!-- Jobs Section -->
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #374151;">
                        <i class="fas fa-tasks"></i> Jobs
                    </h3>
                    <div id="jobs-list">
                        <!-- Job toggles will be loaded here -->
                    </div>
                </div>

                <!-- Alliance activities are now configured in the dedicated Alliance Activities tab -->

                <!-- Threads Section -->
                <div>
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #374151;">
                        <i class="fas fa-code-branch"></i> Threads
                    </h3>
                    <div id="threads-list">
                        <!-- Thread toggles will be loaded here -->
                    </div>
                </div>

                <div class="save-section">
                    <button class="btn btn-secondary">Cancel</button>
                    <button class="btn btn-primary" onclick="saveConfig('settings')">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Config Modal -->
    <div id="create-config-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 500px; box-sizing: border-box; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin: 0 0 20px 0; color: #1e293b;">Create New Config File</h3>

            <div class="input-group" style="margin-bottom: 16px;">
                <label class="input-label">Config File Name:</label>
                <input type="text" id="new-config-name" class="input-field" placeholder="e.g., config_gathering.json"
                    style="width: 100%; box-sizing: border-box;">
                <small style="color: #64748b; font-size: 12px;">File will be saved with .json extension if not
                    provided</small>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label class="input-label">Template:</label>
                <select id="template-select" class="dropdown-field" style="width: 100%; box-sizing: border-box;">
                    <option value="complete_template">Complete Template (Recommended)</option>
                    <option value="">Empty config</option>
                    <option value="config.json">Copy from config.json</option>
                    <option value="config.example.json">Copy from config.example.json</option>
                </select>
                <small style="color: #64748b; font-size: 12px;">Complete Template includes all current config.json
                    features</small>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="hideCreateConfigModal()"
                    style="flex: 1; min-width: 120px;">Cancel</button>
                <button class="btn btn-primary" onclick="createNewConfig()" style="flex: 1; min-width: 120px;">
                    <i class="fas fa-plus"></i> Create Config
                </button>
            </div>
        </div>
    </div>

    <!-- Rename Config Modal -->
    <div id="rename-config-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 500px; box-sizing: border-box; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin: 0 0 20px 0; color: #1e293b;">Rename Config File</h3>

            <div class="input-group" style="margin-bottom: 16px;">
                <label class="input-label">Current Name:</label>
                <input type="text" id="current-config-name" class="input-field" readonly
                    style="width: 100%; box-sizing: border-box; background: #f1f5f9;">
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label class="input-label">New Name:</label>
                <input type="text" id="rename-config-name" class="input-field" placeholder="Enter new config file name"
                    style="width: 100%; box-sizing: border-box;">
                <small style="color: #64748b; font-size: 12px;">Spaces and special characters are allowed. File will be
                    saved with .json extension if not provided</small>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="hideRenameConfigModal()"
                    style="flex: 1; min-width: 120px;">Cancel</button>
                <button class="btn btn-primary" onclick="renameConfig()" style="flex: 1; min-width: 120px;">
                    <i class="fas fa-edit"></i> Rename Config
                </button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Global variables
        let currentConfigFile = '';
        let fullConfigData = {};  // Store the complete config file structure
        let configLoaded = false;

        // Tab switching functionality
        function switchTab(tabName) {
            if (!configLoaded) {
                alert('Please select and load a config file first');
                return;
            }

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Dark mode functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            const slider = document.querySelector('.theme-toggle-slider');
            if (icon && slider) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                slider.style.transform = theme === 'dark' ? 'translateX(20px)' : 'translateX(0)';
            }
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        // Add missing showNotification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Make functions globally available
        window.switchTab = switchTab;
        window.toggleTheme = toggleTheme;
        window.showCreateConfigModal = showCreateConfigModal;
        window.hideCreateConfigModal = hideCreateConfigModal;
        window.showRenameConfigModal = showRenameConfigModal;
        window.hideRenameConfigModal = hideRenameConfigModal;
        window.createNewConfig = createNewConfig;
        window.renameConfig = renameConfig;
        window.loadSelectedConfig = loadSelectedConfig;
        window.deleteCurrentConfig = deleteCurrentConfig;
        window.toggleJob = toggleJob;
        window.toggleThread = toggleThread;
        window.toggleAllianceFarmerFeature = toggleAllianceFarmerFeature;
        window.addSelectedMonster = addSelectedMonster;
        window.addSelectedSocfObject = addSelectedSocfObject;
        window.removeMonsterCard = removeMonsterCard;
        window.addTroopToCard = addTroopToCard;
        window.removeTroopItem = removeTroopItem;
        window.saveConfig = saveConfig;
        window.showNotification = showNotification;

        // Load initial configuration when page loads
        $(document).ready(function () {
            initTheme();
            loadConfigFiles();
            // Disable tabs initially
            disableConfigTabs();
        });

        function loadConfigFiles() {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: '/api/config_files',
                    method: 'GET',
                    timeout: 15000,
                    cache: false,
                    success: function (response) {
                        const configSelect = $('#config-file-select');
                        configSelect.empty();
                        configSelect.append('<option value="">Select a config file</option>');

                        if (response && response.config_files && Array.isArray(response.config_files)) {
                            response.config_files.forEach(file => {
                                configSelect.append(`<option value="${file}">${file}</option>`);
                            });
                            console.log(`Loaded ${response.config_files.length} config files`);
                        } else {
                            console.warn('Invalid response format for config files');
                        }

                        // Enable change event listener (remove previous listeners first)
                        configSelect.off('change.configLoader');
                        configSelect.on('change.configLoader', function () {
                            onConfigFileSelectionChange();
                        });

                        resolve(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to load configuration files:', status, error);
                        showNotification('Failed to load configuration files', 'error');
                        reject(error);
                    }
                });
            });
        }

        function onConfigFileSelectionChange() {
            const selectedFile = document.getElementById('config-file-select').value;
            const loadBtn = document.getElementById('load-config-btn');
            const deleteBtn = document.getElementById('delete-config-btn');
            const renameBtn = document.getElementById('rename-config-btn');

            if (selectedFile) {
                loadBtn.disabled = false;
                deleteBtn.disabled = false;
                renameBtn.disabled = false;
                updateDeleteButtonState();
                updateRenameButtonState();
            } else {
                loadBtn.disabled = true;
                deleteBtn.disabled = true;
                renameBtn.disabled = true;
            }
        }

        function onConfigFileChange() {
            onConfigFileSelectionChange();
        }

        function getCurrentConfigFile() {
            // First try to get from the global variable
            if (typeof currentConfigFile !== 'undefined' && currentConfigFile) {
                return currentConfigFile;
            }
            
            // Fallback to the dropdown selection
            const selectedFile = document.getElementById('config-file-select').value;
            if (selectedFile) {
                return selectedFile;
            }
            
            // Final fallback to default config
            return 'config.json';
        }

        function loadSelectedConfig() {
            const selectedFile = document.getElementById('config-file-select').value;
            if (!selectedFile) {
                alert('Please select a config file first');
                return;
            }

            currentConfigFile = selectedFile;
            loadExistingConfig();
        }

        function disableConfigTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.style.opacity = '0.5';
                tab.style.pointerEvents = 'none';
            });
        }

        function enableConfigTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.style.opacity = '1';
                tab.style.pointerEvents = 'auto';
            });
        }

        function updateDeleteButtonState() {
            const deleteBtn = document.getElementById('delete-config-btn');
            const configSelect = document.getElementById('config-file-select');
            const selectedFile = configSelect.value;

            // Disable delete button for essential config files
            const protectedFiles = ['config.json', 'config.example.json'];
            deleteBtn.disabled = protectedFiles.includes(selectedFile);

            if (deleteBtn.disabled) {
                deleteBtn.style.opacity = '0.5';
                deleteBtn.title = 'Cannot delete essential config files';
            } else {
                deleteBtn.style.opacity = '1';
                deleteBtn.title = 'Delete this config file';
            }
        }

        function updateRenameButtonState() {
            const renameBtn = document.getElementById('rename-config-btn');
            const configSelect = document.getElementById('config-file-select');
            const selectedFile = configSelect.value;

            // Disable rename button for essential config files
            const protectedFiles = ['config.json', 'config.example.json'];
            renameBtn.disabled = protectedFiles.includes(selectedFile);

            if (renameBtn.disabled) {
                renameBtn.style.opacity = '0.5';
                renameBtn.title = 'Cannot rename essential config files';
            } else {
                renameBtn.style.opacity = '1';
                renameBtn.title = 'Rename this config file';
            }
        }

        function showCreateConfigModal() {
            document.getElementById('create-config-modal').style.display = 'block';
            document.getElementById('new-config-name').focus();
        }

        function hideCreateConfigModal() {
            document.getElementById('create-config-modal').style.display = 'none';
            document.getElementById('new-config-name').value = '';
            document.getElementById('template-select').value = '';
            
            // Reset the create button state in case it's stuck
            const createBtns = document.querySelectorAll('button[onclick="createNewConfig()"]');
            createBtns.forEach(btn => {
                btn.innerHTML = '<i class="fas fa-plus"></i> Create Config';
                btn.disabled = false;
            });
        }

        function createNewConfig() {
            const configName = document.getElementById('new-config-name').value.trim();
            const templateFile = document.getElementById('template-select').value;

            if (!configName) {
                showNotification('Please enter a config file name', 'warning');
                return;
            }

            // Add .json extension if not present
            const fileName = configName.endsWith('.json') ? configName : configName + '.json';

            // Allow spaces and more characters in filenames
            const invalidChars = /[<>:"/\\|?*\x00-\x1F]/;
            if (invalidChars.test(fileName)) {
                showNotification('Invalid filename. Cannot contain: < > : " / \\ | ? * or control characters.', 'error');
                return;
            }

            // Check if file already exists
            const existingFiles = Array.from(document.getElementById('config-file-select').options).map(opt => opt.value);
            if (existingFiles.includes(fileName)) {
                if (!confirm(`Config file "${fileName}" already exists. Do you want to overwrite it?`)) {
                    return;
                }
            }

            const createBtn = event.target;
            const originalText = createBtn.innerHTML;
            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            createBtn.disabled = true;

            // Handle complete template option
            if (templateFile === 'complete_template') {
                console.log(`Creating config ${fileName} with complete hardcoded template`);
                const completeConfig = getDefaultConfig();
                if (validateConfigStructure(completeConfig)) {
                    saveNewConfigWithRetry(fileName, completeConfig, createBtn, originalText, 5);
                } else {
                    console.error('Complete template validation failed');
                    createBtn.innerHTML = originalText;
                    createBtn.disabled = false;
                    showNotification('Failed to create complete template structure', 'error');
                }
            } else if (templateFile && templateFile !== '') {
                console.log(`Creating config ${fileName} from template ${templateFile}`);
                loadTemplateWithRetry(templateFile, fileName, createBtn, originalText, 5);
            } else {
                console.log(`Creating config ${fileName} with default structure`);
                const defaultConfig = getDefaultConfig();
                if (validateConfigStructure(defaultConfig)) {
                    saveNewConfigWithRetry(fileName, defaultConfig, createBtn, originalText, 5);
                } else {
                    console.error('Default config validation failed');
                    createBtn.innerHTML = originalText;
                    createBtn.disabled = false;
                    showNotification('Failed to create default config structure', 'error');
                }
            }
        }

        function showRenameConfigModal() {
            const selectedFile = document.getElementById('config-file-select').value;
            if (!selectedFile) {
                showNotification('Please select a config file first', 'warning');
                return;
            }

            const protectedFiles = ['config.json', 'config.example.json'];
            if (protectedFiles.includes(selectedFile)) {
                showNotification('Cannot rename essential config files', 'error');
                return;
            }

            document.getElementById('current-config-name').value = selectedFile;
            document.getElementById('rename-config-name').value = selectedFile;
            document.getElementById('rename-config-modal').style.display = 'block';
            document.getElementById('rename-config-name').focus();
            document.getElementById('rename-config-name').select();
        }

        function hideRenameConfigModal() {
            document.getElementById('rename-config-modal').style.display = 'none';
            document.getElementById('current-config-name').value = '';
            document.getElementById('rename-config-name').value = '';
        }

        function renameConfig() {
            const currentName = document.getElementById('current-config-name').value;
            const newName = document.getElementById('rename-config-name').value.trim();

            if (!newName) {
                showNotification('Please enter a new config file name', 'warning');
                return;
            }

            // Add .json extension if not present
            const fileName = newName.endsWith('.json') ? newName : newName + '.json';

            // Allow spaces and more characters in filenames
            const invalidChars = /[<>:"/\\|?*\x00-\x1F]/;
            if (invalidChars.test(fileName)) {
                showNotification('Invalid filename. Cannot contain: < > : " / \\ | ? * or control characters.', 'error');
                return;
            }

            if (currentName === fileName) {
                showNotification('New name is the same as current name', 'warning');
                return;
            }

            // Check if new file already exists
            const existingFiles = Array.from(document.getElementById('config-file-select').options).map(opt => opt.value);
            if (existingFiles.includes(fileName)) {
                if (!confirm(`Config file "${fileName}" already exists. Do you want to overwrite it?`)) {
                    return;
                }
            }

            const renameBtn = event.target;
            const originalText = renameBtn.innerHTML;
            renameBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Renaming...';
            renameBtn.disabled = true;

            $.ajax({
                url: '/api/config/rename',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    current_name: currentName,
                    new_name: fileName
                }),
                success: function (response) {
                    showNotification(`Config file renamed to '${fileName}' successfully!`, 'success');
                    hideRenameConfigModal();

                    // Refresh config files list
                    loadConfigFiles().then(() => {
                        // Select the renamed file
                        setTimeout(() => {
                            const selectElement = document.getElementById('config-file-select');
                            if (selectElement) {
                                selectElement.value = fileName;
                                onConfigFileSelectionChange();

                                // Update current config file if it was loaded
                                if (currentConfigFile === currentName) {
                                    currentConfigFile = fileName;
                                }
                            }
                        }, 500);
                    });
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON?.error || 'Unknown error';
                    showNotification(`Error renaming config file: ${errorMsg}`, 'error');
                },
                complete: function () {
                    renameBtn.innerHTML = originalText;
                    renameBtn.disabled = false;
                }
            });
        }

        // Expose functions to global window object
        window.showCreateConfigModal = showCreateConfigModal;
        window.hideCreateConfigModal = hideCreateConfigModal;
        window.createNewConfig = createNewConfig;

        function loadTemplateWithRetry(templateFile, fileName, createBtn, originalText, maxRetries) {
            let currentRetry = 0;

            function attemptLoad() {
                currentRetry++;
                console.log(`Attempting to load template ${templateFile} (attempt ${currentRetry}/${maxRetries})`);

                // Update button to show progress
                createBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading template... (${currentRetry}/${maxRetries})`;

                $.ajax({
                    url: '/api/config',
                    method: 'GET',
                    data: {
                        config_file: templateFile,
                        timestamp: Date.now() // Prevent caching
                    },
                    timeout: 20000, // Increased timeout
                    cache: false,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    success: function (templateConfig) {
                        console.log(`Template ${templateFile} loaded, validating structure...`);

                        if (validateConfigStructure(templateConfig)) {
                            console.log(`Template validation successful for ${templateFile} on attempt ${currentRetry}`);

                            // Deep clone the config to prevent reference issues
                            let clonedConfig;
                            try {
                                clonedConfig = JSON.parse(JSON.stringify(templateConfig));

                                // Verify the clone is valid
                                if (!validateConfigStructure(clonedConfig)) {
                                    throw new Error('Config clone validation failed');
                                }

                                console.log(`Template ${templateFile} successfully cloned and validated`);
                                saveNewConfigWithRetry(fileName, clonedConfig, createBtn, originalText, 5);

                            } catch (cloneError) {
                                console.error(`Config cloning failed: ${cloneError.message}`);
                                if (currentRetry < maxRetries) {
                                    setTimeout(attemptLoad, 2000 * currentRetry);
                                } else {
                                    console.warn('Template cloning failed, falling back to default config');
                                    showNotification(`Template cloning failed. Creating with default configuration.`, 'warning');
                                    const defaultConfig = getDefaultConfig();
                                    saveNewConfigWithRetry(fileName, defaultConfig, createBtn, originalText, 5);
                                }
                            }
                        } else {
                            console.error(`Template validation failed for ${templateFile} on attempt ${currentRetry}`);
                            if (currentRetry < maxRetries) {
                                setTimeout(attemptLoad, 2000 * currentRetry);
                            } else {
                                console.warn('All template validation attempts failed, using default config');
                                showNotification(`Template ${templateFile} validation failed after ${maxRetries} attempts. Creating with default configuration.`, 'warning');
                                const defaultConfig = getDefaultConfig();
                                saveNewConfigWithRetry(fileName, defaultConfig, createBtn, originalText, 5);
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        const errorMsg = xhr.responseJSON?.error || `${status}: ${error}`;
                        console.error(`Template load attempt ${currentRetry} failed: ${errorMsg}`);

                        if (currentRetry < maxRetries) {
                            console.log(`Retrying template load in ${2 * currentRetry} seconds...`);
                            setTimeout(attemptLoad, 2000 * currentRetry);
                        } else {
                            console.error('All template load attempts failed, using default config');
                            showNotification(`Failed to load template ${templateFile}. Creating with default configuration.`, 'error');
                            const defaultConfig = getDefaultConfig();
                            saveNewConfigWithRetry(fileName, defaultConfig, createBtn, originalText, 5);
                        }
                    }
                });
            }

            attemptLoad();
        }

        function validateConfigStructure(config) {
            if (!config || typeof config !== 'object') {
                console.error('Config validation failed: not an object');
                return false;
            }

            // Test JSON serialization
            try {
                const serialized = JSON.stringify(config);
                if (!serialized || serialized === '{}') {
                    console.error('Config validation failed: empty after serialization');
                    return false;
                }

                // Test deserialization
                const deserialized = JSON.parse(serialized);
                if (!deserialized || typeof deserialized !== 'object') {
                    console.error('Config validation failed: deserialization failed');
                    return false;
                }
            } catch (e) {
                console.error('Config validation failed: JSON serialization error:', e);
                return false;
            }

            // Ensure essential top-level sections exist
            const requiredSections = ['main', 'rally', 'discord'];
            let sectionsAdded = false;

            for (const section of requiredSections) {
                if (!config.hasOwnProperty(section)) {
                    console.log(`Adding missing required section: ${section}`);
                    config[section] = {};
                    sectionsAdded = true;
                }
            }

            // Ensure main section has proper structure
            if (!config.main || typeof config.main !== 'object') {
                config.main = {};
                sectionsAdded = true;
            }

            if (!config.main.jobs || !Array.isArray(config.main.jobs)) {
                config.main.jobs = [];
                sectionsAdded = true;
            }

            if (!config.main.threads || !Array.isArray(config.main.threads)) {
                config.main.threads = [];
                sectionsAdded = true;
            }

            // Ensure rally section has proper structure
            if (!config.rally || typeof config.rally !== 'object') {
                config.rally = {};
                sectionsAdded = true;
            }

            if (!config.rally.join) {
                config.rally.join = {
                    enabled: false,
                    numMarch: 8,
                    level_based_troops: true,
                    targets: []
                };
                sectionsAdded = true;
            }

            if (!config.rally.start) {
                config.rally.start = {
                    enabled: false,
                    numMarch: 6,
                    level_based_troops: true,
                    targets: []
                };
                sectionsAdded = true;
            }

            // Ensure discord section exists
            if (!config.discord || typeof config.discord !== 'object') {
                config.discord = {
                    enabled: false,
                    webhook_url: "",
                    rally_webhook_url: ""
                };
                sectionsAdded = true;
            }

            if (sectionsAdded) {
                console.log('Config structure validation: added missing sections');
            }

            // Final validation: test serialization again after modifications
            try {
                const finalSerialized = JSON.stringify(config);
                if (!finalSerialized || finalSerialized.length < 50) { // Very basic sanity check
                    console.error('Config validation failed: final serialization too short');
                    return false;
                }
            } catch (e) {
                console.error('Config validation failed: final serialization error:', e);
                return false;
            }

            console.log('Config structure validation: passed');
            return true;
        }


        function getDefaultConfig() {
            return {
                "buff_management": {
                    "enabled": true,
                    "production_boosts": {
                        "short_duration": {},
                        "medium_duration": {},
                        "long_duration": {}
                    }
                },
                "discord": {
                    "enabled": true,
                    "enable_chat_monitoring": true,
                    "webhook_url": "",
                    "chat_webhook_url": "",
                    "crystal_mine_level1_webhook_url": "",
                    "custom_webhook_url": "",
                    "dragon_soul_level2plus_webhook_url": "",
                    "gathering_webhook_url": "",
                    "level2plus_webhook_url": "",
                    "level3plus_webhook_url": "",
                    "monster_webhook_url": "",
                    "occupied_resources_webhook_url": "",
                    "rally_webhook_url": ""
                },
                "main": {
                    "jobs": [
                        {"enabled": true, "interval": {"start": 1200, "end": 1800}, "name": "hospital_recover"},
                        {"enabled": false, "interval": {"start": 30, "end": 90}, "name": "wall_repair"},
                        {
                            "enabled": true,
                            "interval": {"start": 120, "end": 200},
                            "kwargs": {
                                "gift_claim": true,
                                "help_all": true,
                                "research_donate": true,
                                "shop_auto_buy_item_code_list": [10101008]
                            },
                            "name": "alliance_farmer"
                        },
                        {"enabled": false, "interval": {"start": 120, "end": 200}, "name": "mail_claim"},
                        {"enabled": true, "interval": {"start": 120, "end": 200}, "name": "caravan_farmer"},
                        {"enabled": false, "interval": {"start": 120, "end": 200}, "name": "use_resource_in_item_list"},
                        {"enabled": true, "interval": {"start": 120, "end": 200}, "name": "vip_chest_claim"},
                        {"enabled": false, "interval": {"start": 120, "end": 200}, "name": "dsavip_chest_claim"},
                        {"enabled": false, "interval": {"start": 10, "end": 20}, "name": "harvester"},
                        {
                            "enabled": false,
                            "interval": {"start": 1, "end": 1},
                            "kwargs": {
                                "radius": 16,
                                "share_to": {"chat_channels": [0, 0]},
                                "targets": [
                                    {"code": 20100106, "enabled": false, "level": [2, 3, 4, 5], "name": "Dragon Soul Cavern"},
                                    {"code": 20100101, "enabled": false, "level": [7, 8, 9, 10], "name": "Farm"},
                                    {"code": 20100102, "enabled": false, "level": [7, 8, 9, 10], "name": "Gold Mine"},
                                    {"code": 20100103, "enabled": false, "level": [7, 8, 9, 10], "name": "Lumber Camp"},
                                    {"code": 20100104, "enabled": false, "level": [7, 8, 9, 10], "name": "Quarry"},
                                    {"code": 20200103, "enabled": false, "level": [1, 2, 3], "name": "Golem"},
                                    {"code": 20200301, "enabled": false, "level": [1, 2, 3], "name": "Orc"},
                                    {"code": 20200302, "enabled": false, "level": [1, 2, 3], "name": "Skeleton"},
                                    {"code": 20200201, "enabled": false, "level": [1, 2, 3, 4], "name": "Deathkar"},
                                    {"code": 20100105, "enabled": true, "level": [2, 3, 4], "name": "Crystal Mine"}
                                ]
                            },
                            "name": "socf_thread"
                        }
                    ],
                    "normal_monsters": {
                        "enabled": false,
                        "max_distance": 200,
                        "common_troops": [
                            {"code": 50100304, "name": "Iron Cavalry (Tier 4 Cavalry)", "amount": 0},
                            {"code": 50100305, "name": "Dragoon (Tier 5 Cavalry)", "amount": 0},
                            {"code": 50100306, "name": "Marauder (Tier 6 Cavalry)", "amount": 0}
                        ],
                        "targets": [
                            {"monster_code": 20200103, "monster_name": "Golem", "level_ranges": [1, 2, 3]},
                            {"monster_code": 20200104, "monster_name": "Treasure Goblin", "level_ranges": [1, 2, 3, 4]},
                            {"monster_code": 20200101, "monster_name": "Orc", "level_ranges": [1, 2, 3]},
                            {"monster_code": 20200102, "monster_name": "Skeleton", "level_ranges": [1, 2, 3]}
                        ]
                    },
                    "object_scanning": {
                        "enabled": false,
                        "enable_gathering": false,
                        "enable_monster_attack": false,
                        "notify_discord": false,
                        "max_marches": 10,
                        "monster_attack": {"enabled": false},
                        "monster_distance_check": {"enabled": false, "max_distance": 250},
                        "objects": {}
                    },
                    "skills": {
                        "enabled": true,
                        "skills": [
                            {"code": 10018, "enabled": true, "name": "Increase Resource Production"}, 
                            {"code": 10001, "enabled": true, "name": "Instant Harvest"}, 
                            {"code": 10002, "enabled": true, "name": "Accelerated Gathering"}
                        ]
                    },
                    "threads": [
                        {"enabled": true, "name": "free_chest_farmer_thread"},
                        {"enabled": true, "name": "quest_monitor_thread"},
                        {"enabled": false, "name": "building_farmer_thread", "kwargs": {"speedup": true}},
                        {"enabled": false, "name": "academy_farmer_thread", "kwargs": {"speedup": true, "to_max_level": false}},
                        {
                            "enabled": false,
                            "name": "train_troop_thread",
                            "kwargs": {"interval": 3600, "speedup": true, "troop_code": 50100101}
                        }
                    ],
                    "treasure": {"enabled": false, "page": 1}
                },
                "rally": {
                    "join": {
                        "enabled": false,
                        "numMarch": 8,
                        "max_rally_distance": 500,
                        "level_based_troops": true,
                        "targets": []
                    },
                    "start": {
                        "enabled": false,
                        "numMarch": 6,
                        "max_rally_distance": 500,
                        "level_based_troops": true,
                        "targets": []
                    }
                },
                "socketio": {
                    "debug": false,
                    "engineio_logging": false
                },
                "toggles": {
                    "features": {
                        "chat_monitoring": true,
                        "discord": true,
                        "enable_chat_monitoring": true,
                        "enable_gathering": false,
                        "enable_monster_attack": false,
                        "notify_discord": false,
                        "object_scanning": false,
                        "rally_join": false,
                        "rally_start": false
                    },
                    "jobs": {
                        "alliance_farmer": true,
                        "caravan_farmer": true,
                        "dsavip_chest_claim": false,
                        "harvester": false,
                        "hospital_recover": true,
                        "mail_claim": false,
                        "socf_thread": false,
                        "use_resource_in_item_list": false,
                        "vip_chest_claim": true,
                        "wall_repair": false
                    },
                    "threads": {
                        "academy_farmer_thread": false,
                        "building_farmer_thread": false,
                        "free_chest_farmer_thread": true,
                        "quest_monitor_thread": true,
                        "train_troop_thread": false
                    }
                }
            };
        }


        function saveNewConfigWithRetry(fileName, configData, createBtn, originalText, maxRetries) {
            let currentRetry = 0;

            function attemptSave() {
                currentRetry++;
                console.log(`Attempting to save config ${fileName} (attempt ${currentRetry}/${maxRetries})`);

                // Update button to show progress
                createBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving... (${currentRetry}/${maxRetries})`;

                // Validate config data before saving
                if (!validateConfigStructure(configData)) {
                    console.error('Config validation failed before save, using default');
                    configData = getDefaultConfig();
                    if (!validateConfigStructure(configData)) {
                        console.error('Default config validation also failed');
                        createBtn.innerHTML = originalText;
                        createBtn.disabled = false;
                        hideCreateConfigModal();
                        showNotification('Critical error: unable to create valid config structure', 'error');
                        return;
                    }
                }

                // Create a verified copy of the config
                let verifiedConfig;
                try {
                    // Deep clone and verify
                    verifiedConfig = JSON.parse(JSON.stringify(configData));
                    if (!validateConfigStructure(verifiedConfig)) {
                        throw new Error('Config verification failed after clone');
                    }
                } catch (e) {
                    console.error(`Config verification failed: ${e.message}`);
                    if (currentRetry < maxRetries) {
                        setTimeout(attemptSave, 3000 * currentRetry);
                        return;
                    } else {
                        createBtn.innerHTML = originalText;
                        createBtn.disabled = false;
                        hideCreateConfigModal();
                        showNotification('Failed to verify config structure', 'error');
                        return;
                    }
                }

                // Prepare request data
                const requestData = {
                    config: verifiedConfig,
                    config_file: fileName,
                    timestamp: Date.now(),
                    validation_checksum: btoa(JSON.stringify(verifiedConfig)).slice(0, 20) // Simple checksum
                };

                console.log(`Saving config ${fileName} with ${Object.keys(verifiedConfig).length} top-level sections`);

                $.ajax({
                    url: '/api/config',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    timeout: 30000, // Increased timeout
                    cache: false,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    success: function (response) {
                        console.log(`Config save response received for ${fileName} on attempt ${currentRetry}`);

                        // Verify the response
                        if (response && response.success) {
                            console.log(`Config file '${fileName}' created successfully`);
                            showNotification(`Config file '${fileName}' created successfully!`, 'success');
                            
                            // Reset button state before hiding modal
                            createBtn.innerHTML = originalText;
                            createBtn.disabled = false;
                            
                            hideCreateConfigModal();

                            // Verify the file was created by reloading config list
                            loadConfigFiles().then(() => {
                                // Set timeout to allow list to populate
                                setTimeout(() => {
                                    const selectElement = document.getElementById('config-file-select');
                                    if (selectElement) {
                                        // Check if the new file appears in the list
                                        const option = Array.from(selectElement.options).find(opt => opt.value === fileName);
                                        if (option) {
                                            selectElement.value = fileName;
                                            onConfigFileSelectionChange();
                                            console.log(`Successfully selected new config file ${fileName}`);
                                        } else {
                                            console.warn(`New config file ${fileName} not found in list, will retry...`);
                                            // Retry loading the list
                                            setTimeout(() => loadConfigFiles(), 2000);
                                        }
                                    }
                                }, 1500);
                            }).catch(error => {
                                console.error('Error reloading config files:', error);
                                showNotification('Config created but failed to refresh file list', 'warning');
                            });
                        } else {
                            const errorMsg = response?.error || 'Invalid response format';
                            throw new Error(errorMsg);
                        }
                    },
                    error: function (xhr, status, error) {
                        const errorMsg = xhr.responseJSON?.error || `${status}: ${error}` || 'Unknown error';
                        console.error(`Save attempt ${currentRetry} failed: ${errorMsg}`);

                        if (currentRetry < maxRetries) {
                            console.log(`Retrying save in ${3 * currentRetry} seconds...`);
                            setTimeout(attemptSave, 3000 * currentRetry); // Longer intervals
                        } else {
                            console.error('All save attempts failed');
                            showNotification(`Failed to create config file after ${maxRetries} attempts: ${errorMsg}`, 'error');
                            createBtn.innerHTML = originalText;
                            createBtn.disabled = false;
                            hideCreateConfigModal();
                        }
                    },
                    complete: function () {
                        if (currentRetry >= maxRetries) {
                            createBtn.innerHTML = originalText;
                            createBtn.disabled = false;
                        }
                    }
                });
            }

            attemptSave();
        }

        function deleteCurrentConfig() {
            const configSelect = document.getElementById('config-file-select');
            const selectedFile = configSelect.value;

            if (!selectedFile) {
                alert('Please select a config file first');
                return;
            }

            // Double check protection
            const protectedFiles = ['config.json', 'config.example.json'];
            if (protectedFiles.includes(selectedFile)) {
                alert('Cannot delete essential config files');
                return;
            }

            if (!confirm(`Are you sure you want to delete '${selectedFile}'? This action cannot be undone.`)) {
                return;
            }

            $.ajax({
                url: '/api/config/delete',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({
                    config_file: selectedFile
                }),
                success: function (response) {
                    alert(`Config file '${selectedFile}' deleted successfully!`);

                    // Reset interface
                    configLoaded = false;
                    currentConfigFile = '';
                    fullConfigData = {};
                    disableConfigTabs();

                    // Clear all tab contents
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                    });

                    // Refresh config files list
                    loadConfigFiles();
                },
                error: function (xhr) {
                    alert('Error deleting config file: ' + (xhr.responseJSON?.error || 'Unknown error'));
                }
            });
        }



        function loadExistingConfig() {
            // Show loading state
            const loadBtn = document.getElementById('load-config-btn');
            const originalText = loadBtn.innerHTML;
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            loadBtn.disabled = true;

            // Load the complete config file first
            $.ajax({
                url: '/api/config',
                method: 'GET',
                data: {config_file: currentConfigFile},
                success: function (response) {
                    fullConfigData = response;  // Store the complete config
                    configLoaded = true;

                    // Enable tabs and select first tab
                    enableConfigTabs();
                    document.querySelector('.tab').classList.add('active');
                    document.getElementById('rally-join').classList.add('active');

                    // Populate the simplified interface
                    populateRallyJoinConfig(response.rally?.join || {});
                    populateRallyStartConfig(response.rally?.start || {});
                    populateMonsterAttackConfig(response.main?.normal_monsters || {});
                    populateSocfObjectsConfig(response.main?.jobs || []);
                    populateBuffManagementConfig(response.buff_management || {});
                    populateAllianceActivitiesConfig(response.alliance_activities || {});
                    populateSkillsConfig(response.main?.skills || {});
                    populateTreasureConfig(response.main?.treasure || {});
                    populateDsavipConfig(response.main?.jobs || []);
                    populateSettingsConfig(response.main?.jobs || [], response.main?.threads || []);

                    alert(`Configuration file '${currentConfigFile}' loaded successfully!`);
                },
                error: function (xhr) {
                    console.error('Error loading configuration:', xhr);
                    alert('Error loading configuration: ' + (xhr.responseJSON?.error || 'Unknown error'));
                    configLoaded = false;
                },
                complete: function () {
                    loadBtn.innerHTML = originalText;
                    loadBtn.disabled = false;
                }
            });
        }

        function populateRallyJoinConfig(config) {
            console.log('Loading rally-join config:', config);

            // Set enabled state
            document.getElementById('rally-join-enabled').checked = config.enabled || false;

            // Set number of marches
            const marchesInput = document.getElementById('rally-join-marches');
            if (config.numMarch) {
                marchesInput.value = config.numMarch;
            }

            // Set distance (look for max_rally_distance in the config)
            const distanceInput = document.getElementById('rally-join-distance');
            if (config.max_rally_distance) {
                distanceInput.value = config.max_rally_distance;
            }

            // Load skin change settings
            const skinChangeEnabled = config.skin_change_enabled || false;
            document.getElementById('rally-join-skin-change-enabled').checked = skinChangeEnabled;

            const skinItemId = config.skin_item_id || '';
            document.getElementById('rally-join-skin-item-id').value = skinItemId;


            // Clear and populate monsters
            const container = document.getElementById('rally-join-monsters');
            container.innerHTML = '';

            if (config.targets && config.targets.length > 0) {
                config.targets.forEach(monster => {
                    const card = createMonsterCardFromConfig(monster, 'rally-join');
                    container.appendChild(card);
                });
            }
        }

        function populateRallyStartConfig(config) {
            console.log('Loading rally-start config:', config);

            // Set enabled state
            document.getElementById('rally-start-enabled').checked = config.enabled || false;

            // Set number of marches
            const marchesInput = document.getElementById('rally-start-marches');
            if (config.numMarch) {
                marchesInput.value = config.numMarch;
            }

            // Set distance
            const distanceInput = document.getElementById('rally-start-distance');
            if (config.max_rally_distance) {
                distanceInput.value = config.max_rally_distance;
            }

            // Load skin change settings
            const skinChangeEnabled = config.skin_change_enabled || false;
            document.getElementById('rally-start-skin-change-enabled').checked = skinChangeEnabled;

            const skinItemId = config.skin_item_id || '';
            document.getElementById('rally-start-skin-item-id').value = skinItemId;


            // Clear and populate monsters
            const container = document.getElementById('rally-start-monsters');
            container.innerHTML = '';

            if (config.targets && config.targets.length > 0) {
                config.targets.forEach(monster => {
                    const card = createMonsterCardFromConfig(monster, 'rally-start');
                    container.appendChild(card);
                });
            }
        }

        function populateMonsterAttackConfig(config) {
            console.log('Loading monster-attack config:', config);

            // Set enabled state
            document.getElementById('monster-attack-enabled').checked = config.enabled || false;

            // Set distance check enabled state
            const distanceCheckEnabled = (fullConfigData && fullConfigData.main && 
                                        fullConfigData.main.object_scanning && 
                                        fullConfigData.main.object_scanning.monster_distance_check &&
                                        fullConfigData.main.object_scanning.monster_distance_check.enabled) || false;
            document.getElementById('monster-distance-check-enabled').checked = distanceCheckEnabled;

            // Set distance
            const distanceInput = document.getElementById('monster-attack-distance');
            const distanceValue = (fullConfigData && fullConfigData.main && 
                                 fullConfigData.main.object_scanning && 
                                 fullConfigData.main.object_scanning.monster_distance_check &&
                                 fullConfigData.main.object_scanning.monster_distance_check.max_distance) || 
                                config.max_distance || 250;
            distanceInput.value = distanceValue;

            // Clear and populate monsters
            const container = document.getElementById('monster-attack-monsters');
            container.innerHTML = '';

            if (config.targets && config.targets.length > 0) {
                config.targets.forEach(monster => {
                    // Convert monster attack format to standard format for UI
                    const standardMonster = {
                        monster_code: monster.monster_code,
                        monster_name: monster.monster_name,
                        level_ranges: [{
                            min_level: Array.isArray(monster.level_ranges) ? Math.min(...monster.level_ranges) : 1,
                            max_level: Array.isArray(monster.level_ranges) ? Math.max(...monster.level_ranges) : 10,
                            troops: monster.troops || []
                        }]
                    };
                    const card = createMonsterCardFromConfig(standardMonster, 'monster-attack');
                    container.appendChild(card);
                });
            }

            // Load common troops section with improved styling
            const commonTroopsContainer = document.createElement('div');
            commonTroopsContainer.innerHTML = `
                <div class="monster-card" style="margin-top: 24px;">
                    <div class="monster-header">
                        <i class="fas fa-users" style="color: #3b82f6; font-size: 18px;"></i>
                        <span class="monster-name" style="font-size: 18px;">Common Troops Configuration</span>
                    </div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 20px;">
                        Configure default troop compositions for monster attacks
                    </div>
                    <div id="common-troops-list"></div>
                    <button class="btn btn-primary" onclick="addCommonTroop()" style="margin-top: 16px;">
                        <i class="fas fa-plus"></i> Add Troop Type
                    </button>
                </div>
            `;
            container.appendChild(commonTroopsContainer);

            // Populate common troops
            const commonTroopsList = document.getElementById('common-troops-list');
            if (config.common_troops && config.common_troops.length > 0) {
                config.common_troops.forEach((troop, index) => {
                    const troopItem = createCommonTroopItem(troop, index);
                    commonTroopsList.appendChild(troopItem);
                });
            }
        }

        function createMonsterCardFromConfig(monster, configType) {
            const card = document.createElement('div');
            card.className = 'monster-card';

            const monsterName = monster.monster_name || 'Unknown Monster';
            const levelRange = monster.level_ranges && monster.level_ranges.length > 0 ? monster.level_ranges[0] : {min_level: 1, max_level: 10, troops: []};

            card.innerHTML = `
                <div class="monster-header">
                    <input type="checkbox" class="monster-checkbox" checked data-monster-code="${monster.monster_code}">
                    <span class="monster-name">${monsterName}</span>
                    <button class="btn btn-danger" onclick="removeMonsterCard(this)" style="margin-left: auto;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div class="level-inputs">
                    <div class="input-group">
                        <label class="input-label">Min Level:</label>
                        <input type="number" class="input-field min-level" value="${levelRange.min_level || 1}" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max Level:</label>
                        <input type="number" class="input-field max-level" value="${levelRange.max_level || 10}" min="1" max="50">
                    </div>
                </div>

                <div class="troops-section">
                    <div class="troops-header">
                        <span class="troops-title">Troops to be Used</span>
                        <select class="dropdown-field">
                            <option>Custom</option>
                            <option>Default</option>
                            <option>Preset 1</option>
                        </select>
                    </div>

                    <div class="troops-list">
                        <!-- Troops will be populated here -->
                    </div>

                    <button class="btn btn-primary" onclick="addTroopToCard(this)">
                        <i class="fas fa-plus"></i>
                        Add Other Troop
                    </button>
                </div>
            `;

            // Populate troops
            const troopsContainer = card.querySelector('.troops-list');
            if (levelRange.troops && levelRange.troops.length > 0) {
                levelRange.troops.forEach(troop => {
                    const troopItem = document.createElement('div');
                    troopItem.className = 'troop-item';

                    // Handle both old min/max format and new fixed_amounts format
                    let fixedAmounts = troop.fixed_amounts || [];
                    if (fixedAmounts.length === 0 && (troop.min_amount || troop.max_amount)) {
                        // Convert old format to new format
                        fixedAmounts = [troop.min_amount || 0, troop.max_amount || 0].filter(amt => amt > 0);
                    }

                    troopItem.innerHTML = `
                        <select class="troop-select" data-troop-code="${troop.code}">
                            <option value="${troop.code}" selected>${troop.name || getTroopNameByCode(troop.code)}</option>
                            <!-- Tier 6 Troops -->
                            <option value="50100106">Paladin (Tier 6 Infantry)</option>
                            <option value="50100107">Destroyer (Tier 6 Infantry)</option>
                            <option value="50100206">Marksman (Tier 6 Ranged)</option>
                            <option value="50100207">Musketeer (Tier 6 Ranged)</option>
                            <option value="50100306">Marauder (Tier 6 Cavalry)</option>
                            <option value="50100307">Valkyrie (Tier 6 Cavalry)</option>
                            <!-- Tier 5 Troops -->
                            <option value="50100105">Crusader (Tier 5 Infantry)</option>
                            <option value="50100205">Sniper (Tier 5 Ranged)</option>
                            <option value="50100305">Dragoon (Tier 5 Cavalry)</option>
                            <!-- Tier 4 Troops -->
                            <option value="50100104">Guardian (Tier 4 Infantry)</option>
                            <option value="50100204">Crossbow Man (Tier 4 Ranged)</option>
                            <option value="50100304">Iron Cavalry (Tier 4 Cavalry)</option>
                            <!-- Tier 3 Troops -->
                            <option value="50100103">Knight (Tier 3 Infantry)</option>
                            <option value="50100203">Ranger (Tier 3 Ranged)</option>
                            <option value="50100303">Heavy Cavalry (Tier 3 Cavalry)</option>
                        </select>
                        <div class="fixed-amounts-container">
                            <label class="input-label">Fixed Amounts (comma-separated):</label>
                            <input type="text" class="fixed-amounts-input" value="${fixedAmounts.join(', ')}" placeholder="e.g., 10000, 15000, 20000">
                            <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                                Bot will randomly select one amount from the list
                            </small>
                        </div>
                        <button class="btn btn-danger" onclick="removeTroopItem(this)">Remove</button>
                    `;
                    troopsContainer.appendChild(troopItem);
                });
            }

            return card;
        }

        function getTroopNameByCode(code) {
            const troopNames = {
                // Tier 6 Troops
                50100106: 'Paladin (Tier 6 Infantry)',
                50100107: 'Destroyer (Tier 6 Infantry)',
                50100206: 'Marksman (Tier 6 Ranged)',
                50100207: 'Musketeer (Tier 6 Ranged)',
                50100306: 'Marauder (Tier 6 Cavalry)',
                50100307: 'Valkyrie (Tier 6 Cavalry)',
                // Tier 5 Troops
                50100105: 'Crusader (Tier 5 Infantry)',
                50100205: 'Sniper (Tier 5 Ranged)',
                50100305: 'Dragoon (Tier 5 Cavalry)',
                // Tier 4 Troops
                50100104: 'Guardian (Tier 4 Infantry)',
                50100204: 'Crossbow Man (Tier 4 Ranged)',
                50100304: 'Iron Cavalry (Tier 4 Cavalry)',
                // Tier 3 Troops
                50100103: 'Knight (Tier 3 Infantry)',
                50100203: 'Ranger (Tier 3 Ranged)',
                50100303: 'Heavy Cavalry (Tier 3 Cavalry)',
                // Legacy support for older configurations
                50100302: 'Horseman (Tier 2 Cavalry)',
                50100301: 'Scout (Tier 1 Cavalry)',
                50100202: 'Longbow Man (Tier 2 Ranged)',
                50100201: 'Hunter (Tier 1 Ranged)',
                50100102: 'Warrior (Tier 2 Infantry)',
                50100101: 'Fighter (Tier 1 Infantry)'
            };
            return troopNames[code] || `Troop ${code}`;
        }

        // Add selected monster functionality
        function addSelectedMonster(configType) {
            const selectElement = document.getElementById(`${configType}-monster-select`);
            const selectedValue = selectElement.value;

            if (!selectedValue) {
                alert('Please select a monster to add');
                return;
            }

            const [monsterCode, monsterName] = selectedValue.split('_');
            const container = document.getElementById(`${configType}-monsters`);

            // Check if monster already exists
            const existingMonsters = container.querySelectorAll('.monster-checkbox');
            for (let checkbox of existingMonsters) {
                if (checkbox.dataset.monsterCode === monsterCode) {
                    alert(`${monsterName} is already configured`);
                    return;
                }
            }

            const monsterCard = createEmptyMonsterCard(monsterName, configType, parseInt(monsterCode));
            container.appendChild(monsterCard);

            // Reset select
            selectElement.value = '';
        }

        // Add new monster functionality (keeping for backwards compatibility)
        function addNewMonster(configType) {
            const container = document.getElementById(`${configType}-monsters`);
            const monsterCard = createEmptyMonsterCard('New Monster', configType);
            container.appendChild(monsterCard);
        }

        function createEmptyMonsterCard(monsterName, configType, monsterCode = 20200201) {
            const card = document.createElement('div');
            card.className = 'monster-card';
            card.innerHTML = `
                <div class="monster-header">
                    <input type="checkbox" class="monster-checkbox" checked data-monster-code="${monsterCode}">
                    <input type="text" class="monster-name" value="${monsterName}" style="background: transparent; border: none; font-weight: 500; font-size: 16px;">
                    <button class="btn btn-danger" onclick="removeMonsterCard(this)" style="margin-left: auto;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div class="level-inputs">
                    <div class="input-group">
                        <label class="input-label">Min Level:</label>
                        <input type="number" class="input-field min-level" value="1" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max Level:</label>
                        <input type="number" class="input-field max-level" value="10" min="1" max="50">
                    </div>
                </div>

                <div class="troops-section">
                    <div class="troops-header">
                        <span class="troops-title">Troops to be Used</span>
                        <select class="dropdown-field">
                            <option>Custom</option>
                            <option>Default</option>
                            <option>Preset 1</option>
                        </select>
                    </div>

                    <div class="troops-list">
                        <!-- Troops will be added here -->
                    </div>

                    <button class="btn btn-primary" onclick="addTroopToCard(this)">
                        <i class="fas fa-plus"></i>
                        Add Other Troop
                    </button>
                </div>
            `;
            return card;
        }

        // Remove monster card
        function removeMonsterCard(button) {
            if (confirm('Are you sure you want to remove this monster configuration?')) {
                button.closest('.monster-card').remove();
            }
        }

        // Add troop to specific card
        function addTroopToCard(button) {
            const troopsContainer = button.previousElementSibling;
            const troopItem = document.createElement('div');
            troopItem.className = 'troop-item';
            troopItem.innerHTML = `
                <select class="troop-select">
                    <!-- Tier 6 Troops -->
                    <option value="50100106">Paladin (Tier 6 Infantry)</option>
                    <option value="50100107">Destroyer (Tier 6 Infantry)</option>
                    <option value="50100206">Marksman (Tier 6 Ranged)</option>
                    <option value="50100207">Musketeer (Tier 6 Ranged)</option>
                    <option value="50100306">Marauder (Tier 6 Cavalry)</option>
                    <option value="50100307">Valkyrie (Tier 6 Cavalry)</option>
                    <!-- Tier 5 Troops -->
                    <option value="50100105">Crusader (Tier 5 Infantry)</option>
                    <option value="50100205">Sniper (Tier 5 Ranged)</option>
                    <option value="50100305">Dragoon (Tier 5 Cavalry)</option>
                    <!-- Tier 4 Troops -->
                    <option value="50100104">Guardian (Tier 4 Infantry)</option>
                    <option value="50100204">Crossbow Man (Tier 4 Ranged)</option>
                    <option value="50100304">Iron Cavalry (Tier 4 Cavalry)</option>
                    <!-- Tier 3 Troops -->
                    <option value="50100103">Knight (Tier 3 Infantry)</option>
                    <option value="50100203">Ranger (Tier 3 Ranged)</option>
                    <option value="50100303">Heavy Cavalry (Tier 3 Cavalry)</option>
                </select>
                <div class="fixed-amounts-container">
                    <label class="input-label">Fixed Amounts (comma-separated):</label>
                    <input type="text" class="fixed-amounts-input" value="10000, 15000, 20000" placeholder="e.g., 10000, 15000, 20000">
                    <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                        Bot will randomly select one amount from the list
                    </small>
                </div>
                <button class="btn btn-danger" onclick="removeTroopItem(this)">Remove</button>
            `;
            troopsContainer.appendChild(troopItem);
        }

        // Remove troop item
        function removeTroopItem(button) {
            button.closest('.troop-item').remove();
        }

        // Area Restrictions Functions
        function addAreaRestriction() {
            const container = document.getElementById('area-restrictions-list');
            const areaDiv = document.createElement('div');
            areaDiv.className = 'monster-card';
            areaDiv.innerHTML = `
                <div class="monster-header">
                    <input type="text" class="input-field area-name" placeholder="Area name (e.g., Safe Zone North)" style="flex: 1; margin-right: 8px;">
                    <button class="btn btn-danger" onclick="removeAreaRestriction(this)">Remove</button>
                </div>
                <div class="level-inputs" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div class="input-group">
                        <label class="input-label">Min X</label>
                        <input type="number" class="input-field area-min-x" min="0" max="2047" placeholder="e.g., 800">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max X</label>
                        <input type="number" class="input-field area-max-x" min="0" max="2047" placeholder="e.g., 1200">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Min Y</label>
                        <input type="number" class="input-field area-min-y" min="0" max="2047" placeholder="e.g., 1200">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max Y</label>
                        <input type="number" class="input-field area-max-y" min="0" max="2047" placeholder="e.g., 1600">
                    </div>
                </div>
                <small style="display: block; color: #64748b; margin-top: 8px; font-size: 12px;">
                    Define rectangular areas where gathering and monster attacks are allowed. Coordinates range from 0 to 2047.
                </small>
            `;
            container.appendChild(areaDiv);
        }

        function removeAreaRestriction(button) {
            button.closest('.monster-card').remove();
        }

        function toggleAreaRestrictions() {
            const enabledElement = document.getElementById('area-restrictions-enabled');
            const enabled = enabledElement ? enabledElement.checked : false;
            const container = document.getElementById('area-restrictions-container');
            container.style.display = enabled ? 'block' : 'none';
        }

        // Add event listener for area restrictions toggle
        document.addEventListener('DOMContentLoaded', function() {
            const areaToggle = document.getElementById('area-restrictions-enabled');
            if (areaToggle) {
                areaToggle.addEventListener('change', toggleAreaRestrictions);
            }
        });

        // Save configuration
        function saveConfig(configType) {
            console.log(`Saving config for: ${configType}`);

            const configFile = document.getElementById('config-file-select').value;
            console.log(`Using config file: ${configFile}`);

            // Get the full config data first
            if (!fullConfigData) {
                alert('No config data loaded. Please refresh the page.');
                return;
            }

            // Ensure toggles structure exists
            if (!fullConfigData.toggles) {
                fullConfigData.toggles = {
                    features: {},
                    jobs: {},
                    threads: {}
                };
            }

            if (configType === 'rally-join') {
                if (!fullConfigData.rally) fullConfigData.rally = {};
                if (!fullConfigData.rally.join) {
                    fullConfigData.rally.join = {
                        enabled: false,
                        numMarch: 8,
                        level_based_troops: true,
                        targets: []
                    };
                }

                // Update enabled state with null check
                const rallyJoinEnabledElement = document.getElementById('rally-join-enabled');
                const rallyJoinEnabled = rallyJoinEnabledElement ? rallyJoinEnabledElement.checked : false;
                fullConfigData.rally.join.enabled = rallyJoinEnabled;

                // Sync to toggles structure
                fullConfigData.toggles.features.rally_join = rallyJoinEnabled;

                // If rally join is enabled, disable conflicting features
                if (rallyJoinEnabled) {
                    // Disable rally start
                    if (!fullConfigData.rally.start) {
                        fullConfigData.rally.start = {
                            enabled: false,
                            numMarch: 6,
                            level_based_troops: true,
                            targets: []
                        };
                    }
                    fullConfigData.rally.start.enabled = false;
                    fullConfigData.toggles.features.rally_start = false;

                    // Disable object scanning (socf_thread)
                    if (fullConfigData.main && fullConfigData.main.jobs) {
                        fullConfigData.main.jobs.forEach(job => {
                            if (job.name === 'socf_thread') {
                                job.enabled = false;
                                fullConfigData.toggles.jobs.socf_thread = false;
                            }
                        });
                    }

                    // Update main.object_scanning.enabled if it exists
                    if (fullConfigData.main && fullConfigData.main.object_scanning) {
                        fullConfigData.main.object_scanning.enabled = false;
                        fullConfigData.toggles.features.object_scanning = false;
                    }

                    // Update UI to reflect the changes immediately
                    const rallyStartToggle = document.getElementById('rally-start-enabled');
                    const socfToggle = document.getElementById('socf-objects-enabled');

                    if (rallyStartToggle) {
                        rallyStartToggle.checked = false;
                    }
                    if (socfToggle) {
                        socfToggle.checked = false;
                    }

                    // Show notification to user
                    showNotification('Rally Join enabled - Rally Start and Object Scanning have been automatically disabled to prevent conflicts.', 'warning');
                }

                // Update number of marches
                const marches = parseInt(document.getElementById('rally-join-marches').value);
                if (marches) {
                    fullConfigData.rally.join.numMarch = marches;
                }

                // Update distance - keep existing structure
                const distance = parseInt(document.getElementById('rally-join-distance').value);
                if (distance) {
                    fullConfigData.rally.join.max_rally_distance = distance;
                }

                // Update targets
                fullConfigData.rally.join.targets = collectMonstersFromUI('rally-join');

                // Update skin change settings with null check
                const rallyJoinSkinEnabledElement = document.getElementById('rally-join-skin-change-enabled');
                const rallyJoinSkinEnabled = rallyJoinSkinEnabledElement ? rallyJoinSkinEnabledElement.checked : false;
                fullConfigData.rally.join.skin_change_enabled = rallyJoinSkinEnabled;

                const rallyJoinSkinItemId = document.getElementById('rally-join-skin-item-id').value;
                fullConfigData.rally.join.skin_item_id = rallyJoinSkinItemId;


            } else if (configType === 'rally-start') {
                if (!fullConfigData.rally) fullConfigData.rally = {};
                if (!fullConfigData.rally.start) {
                    fullConfigData.rally.start = {
                        enabled: false,
                        numMarch: 6,
                        level_based_troops: true,
                        targets: []
                    };
                }

                // Update enabled state
                const rallyStartEnabledElement = document.getElementById('rally-start-enabled');
                const rallyStartEnabled = rallyStartEnabledElement ? rallyStartEnabledElement.checked : false;
                fullConfigData.rally.start.enabled = rallyStartEnabled;

                // Sync to toggles structure
                fullConfigData.toggles.features.rally_start = rallyStartEnabled;

                // If rally start is enabled, disable conflicting features
                if (rallyStartEnabled) {
                    // Disable rally join
                    if (!fullConfigData.rally.join) {
                        fullConfigData.rally.join = {
                            enabled: false,
                            numMarch: 8,
                            level_based_troops: true,
                            targets: []
                        };
                    }
                    fullConfigData.rally.join.enabled = false;
                    fullConfigData.toggles.features.rally_join = false;

                    // Disable object scanning (socf_thread)
                    if (fullConfigData.main && fullConfigData.main.jobs) {
                        fullConfigData.main.jobs.forEach(job => {
                            if (job.name === 'socf_thread') {
                                job.enabled = false;
                                fullConfigData.toggles.jobs.socf_thread = false;
                            }
                        });
                    }

                    // Update main.object_scanning.enabled if it exists
                    if (fullConfigData.main && fullConfigData.main.object_scanning) {
                        fullConfigData.main.object_scanning.enabled = false;
                        fullConfigData.toggles.features.object_scanning = false;
                    }

                    // Update UI to reflect the changes immediately
                    const rallyJoinToggle = document.getElementById('rally-join-enabled');
                    const socfToggle = document.getElementById('socf-objects-enabled');

                    if (rallyJoinToggle) {
                        rallyJoinToggle.checked = false;
                    }
                    if (socfToggle) {
                        socfToggle.checked = false;
                    }

                    // Show notification to user
                    showNotification('Rally Start enabled - Rally Join and Object Scanning have been automatically disabled to prevent conflicts.', 'warning');
                }

                // Update number of marches
                const marches = parseInt(document.getElementById('rally-start-marches').value);
                if (marches) {
                    fullConfigData.rally.start.numMarch = marches;
                }

                // Update distance
                const distance = parseInt(document.getElementById('rally-start-distance').value);
                if (distance) {
                    fullConfigData.rally.start.max_rally_distance = distance;
                }

                // Update targets
                fullConfigData.rally.start.targets = collectMonstersFromUI('rally-start');

                // Update skin change settings
                const rallyStartSkinEnabledElement = document.getElementById('rally-start-skin-change-enabled');
                const rallyStartSkinEnabled = rallyStartSkinEnabledElement ? rallyStartSkinEnabledElement.checked : false;
                fullConfigData.rally.start.skin_change_enabled = rallyStartSkinEnabled;

                const rallyStartSkinItemId = document.getElementById('rally-start-skin-item-id').value;
                fullConfigData.rally.start.skin_item_id = rallyStartSkinItemId;


            } else if (configType === 'monster-attack') {
                if (!fullConfigData.main) fullConfigData.main = {};
                if (!fullConfigData.main.normal_monsters) {
                    fullConfigData.main.normal_monsters = {
                        "enabled": false,
                        "common_troops": [],
                        "targets": []
                    };
                }

                // Ensure object_scanning section exists
                if (!fullConfigData.main.object_scanning) {
                    fullConfigData.main.object_scanning = {
                        "enabled": false,
                        "max_marches": 10,
                        "notify_discord": false,
                        "enable_gathering": false,
                        "enable_monster_attack": false,
                        "objects": {},
                        "monster_attack": {
                            "enabled": false
                        }
                    };
                }

                // Ensure toggles structure exists
                if (!fullConfigData.toggles) fullConfigData.toggles = {};
                if (!fullConfigData.toggles.features) fullConfigData.toggles.features = {};

                // Get the enabled state from UI with safety checks
                const enabledElement = document.getElementById('monster-attack-enabled');
                const isEnabled = enabledElement ? enabledElement.checked : false;

                // Update ALL 4 locations for Monster Attack toggle
                // 1. toggles.features.enable_monster_attack
                fullConfigData.toggles.features.enable_monster_attack = isEnabled;

                // 2. main.object_scanning.enable_monster_attack
                fullConfigData.main.object_scanning.enable_monster_attack = isEnabled;

                // 3. main.object_scanning.monster_attack.enabled
                fullConfigData.main.object_scanning.monster_attack.enabled = isEnabled;

                // 4. main.normal_monsters.enabled
                fullConfigData.main.normal_monsters.enabled = isEnabled;

                // Update distance check settings with safety checks
                const distanceCheckElement = document.getElementById('monster-distance-check-enabled');
                const distanceCheckEnabled = distanceCheckElement ? distanceCheckElement.checked : false;
                
                const distanceElement = document.getElementById('monster-attack-distance');
                const distance = distanceElement ? parseInt(distanceElement.value) : 200;
                
                // Ensure monster_distance_check section exists in object_scanning
                if (!fullConfigData.main.object_scanning.monster_distance_check) {
                    fullConfigData.main.object_scanning.monster_distance_check = {
                        "enabled": false,
                        "max_distance": 250
                    };
                }
                
                // Update monster distance check settings
                fullConfigData.main.object_scanning.monster_distance_check.enabled = distanceCheckEnabled;
                if (distance) {
                    fullConfigData.main.object_scanning.monster_distance_check.max_distance = distance;
                    // Also update the normal_monsters max_distance for backward compatibility
                    fullConfigData.main.normal_monsters.max_distance = distance;
                }

                // Update targets
                fullConfigData.main.normal_monsters.targets = collectMonsterAttackTargetsFromUI();

                // Update common troops
                fullConfigData.main.normal_monsters.common_troops = collectCommonTroopsFromUI();

            } else if (configType === 'socf-objects') {
                if (!fullConfigData.main) fullConfigData.main = {};
                if (!fullConfigData.main.jobs) fullConfigData.main.jobs = [];

                // Ensure object_scanning section exists
                if (!fullConfigData.main.object_scanning) {
                    fullConfigData.main.object_scanning = {
                        "enabled": false,
                        "max_marches": 10,
                        "notify_discord": false,
                        "enable_gathering": false,
                        "enable_monster_attack": false,
                        "objects": {}
                    };
                }

                // Find or create socf_thread job
                let socfJob = fullConfigData.main.jobs.find(job => job.name === 'socf_thread');
                if (!socfJob) {
                    socfJob = {
                        "name": 'socf_thread',
                        "enabled": false,
                        "interval": {"start": 1, "end": 1},
                        "kwargs": {
                            "targets": [],
                            "radius": 16,
                            "share_to": {"chat_channels": [0, 0]}
                        }
                    };
                    fullConfigData.main.jobs.push(socfJob);
                }

                // Update enabled state with null check
                const socfEnabledElement = document.getElementById('socf-objects-enabled');
                const socfEnabled = socfEnabledElement ? socfEnabledElement.checked : false;
                socfJob.enabled = socfEnabled;
                fullConfigData.main.object_scanning.enabled = socfEnabled;

                // Sync to toggles structure
                fullConfigData.toggles.jobs.socf_thread = socfEnabled;
                fullConfigData.toggles.features.object_scanning = socfEnabled;

                // Update gathering enabled state with null check
                const gatheringEnabledElement = document.getElementById('socf-gathering-enabled');
                const gatheringEnabled = gatheringEnabledElement ? gatheringEnabledElement.checked : false;
                fullConfigData.main.object_scanning.enable_gathering = gatheringEnabled;

                // Sync to toggles structure
                fullConfigData.toggles.features.enable_gathering = gatheringEnabled;

                // If SOCF is enabled, disable rally join only (not rally start)
                if (socfEnabled) {
                    // Disable rally join only
                    if (!fullConfigData.rally) fullConfigData.rally = {};
                    if (!fullConfigData.rally.join) {
                        fullConfigData.rally.join = {
                            "enabled": false,
                            "numMarch": 8,
                            "level_based_troops": true,
                            "targets": []
                        };
                    }
                    fullConfigData.rally.join.enabled = false;
                    fullConfigData.toggles.features.rally_join = false;

                    // Update UI to reflect the changes immediately
                    const rallyJoinToggle = document.getElementById('rally-join-enabled');

                    if (rallyJoinToggle) {
                        rallyJoinToggle.checked = false;
                    }

                    // Show notification to user
                    showNotification('Object Scanning enabled - Rally Join has been automatically disabled to prevent conflicts. Rally Start remains available.', 'warning');
                }

                // Update max marches
                const maxMarches = parseInt(document.getElementById('socf-objects-max-marches').value);
                if (maxMarches) {
                    fullConfigData.main.object_scanning.max_marches = maxMarches;
                }

                // Update radius
                const radius = parseInt(document.getElementById('socf-objects-radius').value);
                if (radius) {
                    socfJob.kwargs.radius = radius;
                }

                // Update area restrictions with null check
                const areaRestrictionsEnabledElement = document.getElementById('area-restrictions-enabled');
                const areaRestrictionsEnabled = areaRestrictionsEnabledElement ? areaRestrictionsEnabledElement.checked : false;
                if (!fullConfigData.main.object_scanning.area_restrictions) {
                    fullConfigData.main.object_scanning.area_restrictions = {
                        "enabled": false,
                        "allowed_areas": []
                    };
                }
                fullConfigData.main.object_scanning.area_restrictions.enabled = areaRestrictionsEnabled;

                // Collect area restrictions from UI
                const areaRestrictions = [];
                document.querySelectorAll('#area-restrictions-list .monster-card').forEach(areaCard => {
                    const name = areaCard.querySelector('.area-name').value;
                    const minX = parseInt(areaCard.querySelector('.area-min-x').value);
                    const maxX = parseInt(areaCard.querySelector('.area-max-x').value);
                    const minY = parseInt(areaCard.querySelector('.area-min-y').value);
                    const maxY = parseInt(areaCard.querySelector('.area-max-y').value);
                    
                    if (name && !isNaN(minX) && !isNaN(maxX) && !isNaN(minY) && !isNaN(maxY)) {
                        areaRestrictions.push({
                            name: name,
                            min_x: minX,
                            max_x: maxX,
                            min_y: minY,
                            max_y: maxY
                        });
                    }
                });
                fullConfigData.main.object_scanning.area_restrictions.allowed_areas = areaRestrictions;

                // Update targets
                socfJob.kwargs.targets = collectSocfObjectsFromUI();

                // Update skin change settings with null check
                const socfSkinEnabledElement = document.getElementById('socf-objects-skin-change-enabled');
                const socfSkinEnabled = socfSkinEnabledElement ? socfSkinEnabledElement.checked : false;
                if (!fullConfigData.main.object_scanning.skin_change_settings) {
                    fullConfigData.main.object_scanning.skin_change_settings = {};
                }
                fullConfigData.main.object_scanning.skin_change_settings.enabled = socfSkinEnabled;

                const socfSkinItemId = document.getElementById('socf-objects-skin-item-id').value;
                fullConfigData.main.object_scanning.skin_change_settings.skin_item_id = socfSkinItemId;


            } else if (configType === 'alliance-activities') {
                if (!fullConfigData.alliance_activities) {
                    fullConfigData.alliance_activities = {};
                }

                // Alliance Help All
                fullConfigData.alliance_activities.help_all = {
                    enabled: document.getElementById('alliance-help-enabled').checked,
                    interval_minutes: parseInt(document.getElementById('alliance-help-interval').value) || 5
                };

                // Alliance Gift Claim
                fullConfigData.alliance_activities.gift_claim = {
                    enabled: document.getElementById('alliance-gift-enabled').checked,
                    interval_minutes: parseInt(document.getElementById('alliance-gift-interval').value) || 30
                };

                // Alliance Research Donate
                fullConfigData.alliance_activities.research_donate = {
                    enabled: document.getElementById('alliance-research-enabled').checked,
                    interval_minutes: parseInt(document.getElementById('alliance-research-interval').value) || 60
                };

                // Alliance Shop Auto-Buy
                fullConfigData.alliance_activities.shop_auto_buy = {
                    enabled: document.getElementById('alliance-shop-enabled').checked,
                    interval_minutes: parseInt(document.getElementById('alliance-shop-interval').value) || 120
                };

                // Caravan Auto-Buy
                fullConfigData.alliance_activities.caravan_auto_buy = {
                    enabled: document.getElementById('caravan-auto-buy-enabled').checked,
                    interval_minutes: parseInt(document.getElementById('caravan-interval').value) || 180
                };

                console.log('Alliance activities config being saved:', fullConfigData.alliance_activities);

            } else if (configType === 'buff-management') {
                if (!fullConfigData.buff_management) {
                    fullConfigData.buff_management = {
                        "enabled": false,
                        "production_boosts": {
                            "short_duration": {},
                            "medium_duration": {},
                            "long_duration": {}
                        }
                    };
                }

                // Update enabled state with null check
                const buffEnabledElement = document.getElementById('buff-management-enabled');
                const buffEnabled = buffEnabledElement ? buffEnabledElement.checked : false;
                fullConfigData.buff_management.enabled = buffEnabled;

                // Sync to toggles structure
                fullConfigData.toggles.features.buff_management = buffEnabled;

                // Update production boosts
                fullConfigData.buff_management.production_boosts = collectBuffManagementFromUI();

            } else if (configType === 'skills') {
                const skillsEnabledElement = document.getElementById('skills-enabled');
                const skillsEnabled = skillsEnabledElement ? skillsEnabledElement.checked : false;
                
                // Get individual skill checkboxes by their IDs
                const skill10001 = document.getElementById('skill-10001-enabled');
                const skill10002 = document.getElementById('skill-10002-enabled');

                const skillsConfig = [];
                
                // Add skills if checkboxes exist
                if (skill10001) {
                    skillsConfig.push({
                        code: 10001,
                        enabled: skill10001.checked
                    });
                }
                
                if (skill10002) {
                    skillsConfig.push({
                        code: 10002,
                        enabled: skill10002.checked
                    });
                }

                // Ensure main.skills structure exists
                if (!fullConfigData.main) {
                    fullConfigData.main = {};
                }

                fullConfigData.main.skills = {
                    enabled: skillsEnabled,
                    skills: skillsConfig
                };

                // Update skin change settings for Skills (special workflow)
                const skillsSkinEnabled = document.getElementById('skills-skin-change-enabled').checked;
                fullConfigData.main.skills.skin_change_enabled = skillsSkinEnabled;

                const skillsSkinItemId = document.getElementById('skills-skin-item-id').value;
                fullConfigData.main.skills.skin_item_id = skillsSkinItemId;

                const skillsSkinItemId2 = document.getElementById('skills-skin-item-id-2').value;
                fullConfigData.main.skills.skin_item_id_2 = skillsSkinItemId2;

                // Update treasure page settings for Skills workflow
                const skillsTreasurePage1 = document.getElementById('skills-treasure-page-1').value;
                fullConfigData.main.skills.treasure_page_1 = parseInt(skillsTreasurePage1);

                const skillsTreasurePage2 = document.getElementById('skills-treasure-page-2').value;
                fullConfigData.main.skills.treasure_page_2 = parseInt(skillsTreasurePage2);

                console.log('Skills config being saved:', fullConfigData.main.skills);

            } else if (configType === 'treasure') {
                if (!fullConfigData.main) fullConfigData.main = {};
                if (!fullConfigData.main.treasure) {
                    fullConfigData.main.treasure = {
                        "enabled": false,
                        "page": 1
                    };
                }

                // Update enabled state
                const treasureEnabledElement = document.getElementById('treasure-enabled');
                const treasureEnabled = treasureEnabledElement ? treasureEnabledElement.checked : false;
                fullConfigData.main.treasure.enabled = treasureEnabled;

                // Sync to toggles structure
                fullConfigData.toggles.features.treasure = treasureEnabled;

                // Update treasure page
                const treasurePageSelect = document.getElementById('treasure-page');
                fullConfigData.main.treasure.page = parseInt(treasurePageSelect.value);

                // Update skin change settings
                const skinChangeEnabledElement = document.getElementById('treasure-skin-change-enabled');
                const skinChangeEnabled = skinChangeEnabledElement ? skinChangeEnabledElement.checked : false;
                fullConfigData.main.treasure.skin_change_enabled = skinChangeEnabled;

                const skinItemId = document.getElementById('treasure-skin-item-id').value;
                fullConfigData.main.treasure.skin_item_id = skinItemId;

                const skinChangeInterval = parseInt(document.getElementById('treasure-skin-change-interval').value);
                if (skinChangeInterval) {
                    fullConfigData.main.treasure.skin_change_interval = skinChangeInterval;
                }


            } else if (configType === 'dsavip') {
                const dsavipChestEnabledElement = document.getElementById('dsavip-chest-enabled');
                const dsavipChestEnabled = dsavipChestEnabledElement ? dsavipChestEnabledElement.checked : false;
                const dsavipJobEnabledElement = document.getElementById('dsavip-job-enabled');
                const dsavipJobEnabled = dsavipJobEnabledElement ? dsavipJobEnabledElement.checked : false;

                // Ensure main structure exists
                if (!fullConfigData.main) {
                    fullConfigData.main = {};
                }
                if (!fullConfigData.main.jobs) {
                    fullConfigData.main.jobs = [];
                }

                // Update or add DSA VIP job in jobs array
                let dsavipJob = fullConfigData.main.jobs.find(job => job.name === 'dsavip_chest_claim');
                if (dsavipJob) {
                    dsavipJob.enabled = dsavipJobEnabled;
                } else {
                    fullConfigData.main.jobs.push({
                        enabled: dsavipJobEnabled,
                        interval: {
                            start: 120,
                            end: 200
                        },
                        name: 'dsavip_chest_claim'
                    });
                }

                // Update toggles section if it exists
                if (!fullConfigData.toggles) {
                    fullConfigData.toggles = {};
                }
                if (!fullConfigData.toggles.jobs) {
                    fullConfigData.toggles.jobs = {};
                }
                fullConfigData.toggles.jobs.dsavip_chest_claim = dsavipJobEnabled;

                console.log('DSA VIP config being saved:', {
                    dsavipChestEnabled,
                    dsavipJobEnabled,
                    dsavipJob
                });

            } else if (configType === 'settings') {
                // Settings is more complex - need to update multiple parts
                console.log('Saving settings config');

                // Ensure we have the main structure
                if (!fullConfigData.main) {
                    fullConfigData.main = {};
                }

                // Ensure we have the toggles structure
                if (!fullConfigData.toggles) {
                    fullConfigData.toggles = {
                        jobs: {},
                        threads: {},
                        features: {}
                    };
                }

                // Collect current state from UI
                collectSettingsFromUI();

                // Sync jobs bidirectionally
                if (fullConfigData.main.jobs) {
                    if (!fullConfigData.toggles.jobs) {
                        fullConfigData.toggles.jobs = {};
                    }

                    // Sync from main.jobs to toggles.jobs
                    fullConfigData.main.jobs.forEach(job => {
                        fullConfigData.toggles.jobs[job.name] = job.enabled;
                    });

                    // Sync from toggles.jobs back to main.jobs (in case there are toggles without corresponding jobs)
                    Object.keys(fullConfigData.toggles.jobs).forEach(jobName => {
                        const job = fullConfigData.main.jobs.find(j => j.name === jobName);
                        if (job) {
                            job.enabled = fullConfigData.toggles.jobs[jobName];
                        }
                    });
                }

                // Sync threads bidirectionally
                if (fullConfigData.main.threads) {
                    if (!fullConfigData.toggles.threads) {
                        fullConfigData.toggles.threads = {};
                    }

                    // Sync from main.threads to toggles.threads
                    fullConfigData.main.threads.forEach(thread => {
                        fullConfigData.toggles.threads[thread.name] = thread.enabled;
                    });

                    // Sync from toggles.threads back to main.threads
                    Object.keys(fullConfigData.toggles.threads).forEach(threadName => {
                        const thread = fullConfigData.main.threads.find(t => t.name === threadName);
                        if (thread) {
                            thread.enabled = fullConfigData.toggles.threads[threadName];
                        }
                    });
                }

                console.log('Settings sync completed', {
                    jobsCount: fullConfigData.main.jobs?.length || 0,
                    threadsCount: fullConfigData.main.threads?.length || 0,
                    togglesJobs: Object.keys(fullConfigData.toggles.jobs || {}).length,
                    togglesThreads: Object.keys(fullConfigData.toggles.threads || {}).length
                });
            }

            // Show saving state (only if called from an event)
            let saveBtn = null;
            let originalText = '';
            if (event && event.target) {
                saveBtn = event.target;
                originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;
            }

            $.ajax({
                url: '/api/config',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    "config": fullConfigData,
                    "config_file": configFile
                }),
                success: function (response) {
                    alert(`Configuration file '${configFile}' saved successfully!`);
                },
                error: function (xhr) {
                    alert('Error saving configuration: ' + (xhr.responseJSON?.error || 'Unknown error'));
                },
                complete: function () {
                    if (saveBtn) {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    }
                }
            });
        }

        function collectSocfObjectsFromUI() {
            const container = document.getElementById('socf-objects-list');
            const objects = [];

            container.querySelectorAll('.monster-card').forEach(card => {
                const checkbox = card.querySelector('.monster-checkbox');
                if (!checkbox.checked) return;

                const nameElement = card.querySelector('.monster-name');
                const levelsInput = card.querySelector('.levels-input');

                const name = nameElement.textContent || 'Unknown Object';
                const code = parseInt(checkbox.dataset.objectCode) || 20100105;

                // Parse levels
                let levels = [];
                if (levelsInput.value.trim()) {
                    levels = levelsInput.value.split(',').map(l => parseInt(l.trim())).filter(l => !isNaN(l));
                }

                objects.push({
                    "code": code,
                    "name": name,
                    "level": levels,
                    "enabled": true
                });
            });

            return objects;
        }

        function addSelectedSocfObject() {
            const selectElement = document.getElementById('socf-object-select');
            const selectedValue = selectElement.value;

            if (!selectedValue) {
                alert('Please select an object to add');
                return;
            }

            const [objectCode, objectName] = selectedValue.split('_');
            const container = document.getElementById('socf-objects-list');

            // Check if object already exists
            const existingObjects = container.querySelectorAll('.monster-checkbox');
            for (let checkbox of existingObjects) {
                if (checkbox.dataset.objectCode === objectCode) {
                    alert(`${objectName} is already configured`);
                    return;
                }
            }

            const objectCard = createSocfObjectCard({
                code: parseInt(objectCode),
                name: objectName,
                level: [1, 2, 3, 4, 5],
                enabled: true
            });
            container.appendChild(objectCard);

            // Reset select
            selectElement.value = '';
        }

        function createSocfObjectCard(target) {
            const card = document.createElement('div');
            card.className = 'monster-card';

            card.innerHTML = `
                <div class="monster-header">
                    <input type="checkbox" class="monster-checkbox" ${target.enabled ? 'checked' : ''} data-object-code="${target.code}">
                    <span class="monster-name">${target.name}</span>
                    <button class="btn btn-danger" onclick="removeMonsterCard(this)" style="margin-left: auto;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div class="level-inputs">
                    <div class="input-group">
                        <label class="input-label">Levels (comma-separated):</label>
                        <input type="text" class="input-field levels-input" value="${(target.level || []).join(', ')}" placeholder="e.g., 1, 2, 3, 4, 5">
                        <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                            Specify which levels to target for this object
                        </small>
                    </div>
                </div>
            `;

            return card;
        }

        function collectMonstersFromUI(configType) {
            const container = document.getElementById(`${configType}-monsters`);
            const monsters = [];

            container.querySelectorAll('.monster-card').forEach(card => {
                const checkbox = card.querySelector('.monster-checkbox');
                if (!checkbox || !checkbox.checked) return;

                const monsterNameElement = card.querySelector('.monster-name');
                const monsterName = monsterNameElement.value || monsterNameElement.textContent;
                const monsterCode = parseInt(checkbox.dataset.monsterCode) || getMonsterCodeByName(monsterName);
                const minLevel = parseInt(card.querySelector('.min-level').value) || 1;
                const maxLevel = parseInt(card.querySelector('.max-level').value) || 10;

                const levelRange = {
                    "min_level": minLevel,
                    "max_level": maxLevel,
                    "troops": []
                };

                // Add additional fields for rally-start
                if (configType === 'rally-start') {
                    levelRange.rally_time = 5;
                    levelRange.message = `${monsterName} Rally`;
                }

                const monster = {
                    "monster_code": monsterCode,
                    "monster_name": monsterName,
                    "level_ranges": [levelRange]
                };

                // Collect troops using fixed_amounts
                card.querySelectorAll('.troop-item').forEach(troopItem => {
                    const troopSelect = troopItem.querySelector('.troop-select');
                    const fixedAmountsInput = troopItem.querySelector('.fixed-amounts-input');

                    if (troopSelect.value && fixedAmountsInput.value.trim()) {
                        const troopCode = parseInt(troopSelect.value);

                        // Parse comma-separated fixed amounts
                        const fixedAmounts = fixedAmountsInput.value
                            .split(',')
                            .map(amount => parseInt(amount.trim()))
                            .filter(amount => !isNaN(amount) && amount > 0);

                        if (fixedAmounts.length > 0) {
                            levelRange.troops.push({
                                "code": troopCode,
                                "name": troopSelect.options[troopSelect.selectedIndex].text,
                                "fixed_amounts": fixedAmounts
                            });
                        }
                    }
                });

                monsters.push(monster);
            });

            return monsters;
        }

        function collectMonsterAttackTargetsFromUI() {
            const container = document.getElementById('monster-attack-monsters');
            const monsters = [];

            container.querySelectorAll('.monster-card').forEach(card => {
                const checkbox = card.querySelector('.monster-checkbox');
                if (!checkbox || !checkbox.checked) return;

                const monsterNameElement = card.querySelector('.monster-name');
                const monsterName = monsterNameElement.value || monsterNameElement.textContent;
                const monsterCode = parseInt(checkbox.dataset.monsterCode) || getMonsterCodeByName(monsterName);
                const minLevel = parseInt(card.querySelector('.min-level').value) || 1;
                const maxLevel = parseInt(card.querySelector('.max-level').value) || 10;

                // Create level ranges array for monster attack (different structure)
                const levelRanges = [];
                for (let level = minLevel; level <= maxLevel; level++) {
                    levelRanges.push(level);
                }

                const monster = {
                    "monster_code": monsterCode,
                    "monster_name": monsterName,
                    "level_ranges": levelRanges,
                    "troops": []
                };

                // Collect troops configuration from the troops-list container
                card.querySelectorAll('.troops-list .troop-item').forEach(troopItem => {
                    const troopSelect = troopItem.querySelector('.troop-select');
                    const fixedAmountsInput = troopItem.querySelector('.fixed-amounts-input');

                    if (troopSelect && fixedAmountsInput && troopSelect.value && fixedAmountsInput.value.trim()) {
                        const troopCode = parseInt(troopSelect.value);
                        
                        // Parse comma-separated fixed amounts
                        const fixedAmounts = fixedAmountsInput.value
                            .split(',')
                            .map(amount => parseInt(amount.trim()))
                            .filter(amount => !isNaN(amount) && amount > 0);

                        if (fixedAmounts.length > 0) {
                            monster.troops.push({
                                "code": troopCode,
                                "name": troopSelect.options[troopSelect.selectedIndex].text,
                                "fixed_amounts": fixedAmounts
                            });
                        }
                    }
                });

                monsters.push(monster);
            });

            return monsters;
        }

        function collectCommonTroopsFromUI() {
            const commonTroopsList = document.getElementById('common-troops-list');
            const troops = [];

            if (commonTroopsList) {
                commonTroopsList.querySelectorAll('.troop-item').forEach(troopItem => {
                    const troopSelect = troopItem.querySelector('.troop-select');
                    const amountInput = troopItem.querySelector('.troop-amount-input');

                    if (troopSelect && amountInput && troopSelect.value && amountInput.value !== '') {
                        const troopCode = parseInt(troopSelect.value);
                        const amount = parseInt(amountInput.value) || 0;

                        troops.push({
                            "code": troopCode,
                            "name": troopSelect.options[troopSelect.selectedIndex].text,
                            "amount": amount
                        });
                    }
                });
            }

            return troops;
        }

        function getMonsterCodeByName(monsterName) {
            const codes = {
                'Orc': 20200101,
                'Skeleton': 20200102,
                'Golem': 20200103,
                'Treasure Goblin': 20200104,
                'Ogre': 20700405,
                'BF Orc': 20800401,
                'BF Skeleton': 20800402,
                'BF Golem': 20800403,
                'BF Treasure Goblin': 20800404
            };
            return codes[monsterName] || 20200201;
        }

        function populateSocfObjectsConfig(jobs) {
            console.log('Loading SOCF objects config:', jobs);

            // Find socf_thread job
            const socfJob = jobs.find(job => job.name === 'socf_thread');

            // Set enabled state
            document.getElementById('socf-objects-enabled').checked = socfJob?.enabled || false;

            // Set gathering enabled state from main.object_scanning.enable_gathering
            const gatheringEnabled = fullConfigData.main?.object_scanning?.enable_gathering || false;
            document.getElementById('socf-gathering-enabled').checked = gatheringEnabled;

            // Set max marches from main.object_scanning.max_marches
            const maxMarchesInput = document.getElementById('socf-objects-max-marches');
            if (fullConfigData.main?.object_scanning?.max_marches) {
                maxMarchesInput.value = fullConfigData.main.object_scanning.max_marches;
            }

            // Set radius
            const radiusInput = document.getElementById('socf-objects-radius');
            if (socfJob?.kwargs?.radius) {
                radiusInput.value = socfJob.kwargs.radius;
            }

            // Load skin change settings
            const skinChangeSettings = fullConfigData.main?.object_scanning?.skin_change_settings || {};
            document.getElementById('socf-objects-skin-change-enabled').checked = skinChangeSettings.enabled || false;
            document.getElementById('socf-objects-skin-item-id').value = skinChangeSettings.skin_item_id || '';

            // Load area restrictions
            const areaRestrictions = fullConfigData.main?.object_scanning?.area_restrictions || {};
            const areaRestrictionsEnabled = areaRestrictions.enabled || false;
            document.getElementById('area-restrictions-enabled').checked = areaRestrictionsEnabled;
            
            // Show/hide area restrictions container
            const areaRestrictionsContainer = document.getElementById('area-restrictions-container');
            areaRestrictionsContainer.style.display = areaRestrictionsEnabled ? 'block' : 'none';

            // Clear and populate area restrictions
            const areaContainer = document.getElementById('area-restrictions-list');
            areaContainer.innerHTML = '';

            if (areaRestrictions.allowed_areas && areaRestrictions.allowed_areas.length > 0) {
                areaRestrictions.allowed_areas.forEach(area => {
                    const areaDiv = document.createElement('div');
                    areaDiv.className = 'monster-card';
                    areaDiv.innerHTML = `
                        <div class="monster-header">
                            <input type="text" class="input-field area-name" placeholder="Area name (e.g., Safe Zone North)" style="flex: 1; margin-right: 8px;" value="${area.name || ''}">
                            <button class="btn btn-danger" onclick="removeAreaRestriction(this)">Remove</button>
                        </div>
                        <div class="level-inputs" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                            <div class="input-group">
                                <label class="input-label">Min X</label>
                                <input type="number" class="input-field area-min-x" min="0" max="2047" placeholder="e.g., 800" value="${area.min_x || ''}">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Max X</label>
                                <input type="number" class="input-field area-max-x" min="0" max="2047" placeholder="e.g., 1200" value="${area.max_x || ''}">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Min Y</label>
                                <input type="number" class="input-field area-min-y" min="0" max="2047" placeholder="e.g., 1200" value="${area.min_y || ''}">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Max Y</label>
                                <input type="number" class="input-field area-max-y" min="0" max="2047" placeholder="e.g., 1600" value="${area.max_y || ''}">
                            </div>
                        </div>
                        <small style="display: block; color: #64748b; margin-top: 8px; font-size: 12px;">
                            Define rectangular areas where gathering and monster attacks are allowed. Coordinates range from 0 to 2047.
                        </small>
                    `;
                    areaContainer.appendChild(areaDiv);
                });
            }

            // Clear and populate objects
            const container = document.getElementById('socf-objects-list');
            container.innerHTML = '';

            // Define default objects to show
            const defaultObjects = [
                { code: 20100105, name: "Crystal Mine", level: [1, 2, 3, 4, 5], enabled: true },
                { code: 20100106, name: "Dragon Soul Cavern", level: [1, 2, 3, 4, 5], enabled: true }
            ];

            // If we have existing targets, use those; otherwise show default objects
            let objectsToShow = [];
            if (socfJob?.kwargs?.targets && socfJob.kwargs.targets.length > 0) {
                objectsToShow = socfJob.kwargs.targets;
            } else {
                // Show only Crystal Mine and Dragon Soul Cavern by default
                objectsToShow = defaultObjects;
            }

            objectsToShow.forEach(target => {
                const card = createSocfObjectCard(target);
                container.appendChild(card);
            });

            // If no objects were shown, add the two default objects
            if (objectsToShow.length === 0) {
                defaultObjects.forEach(defaultObject => {
                    const card = createSocfObjectCard(defaultObject);
                    container.appendChild(card);
                });
            }
        }

        // Production Boost Data
        const PRODUCTION_BOOST_DATA = {
            short_duration: [
                {"code": 10102011, "name": "March size boost", "ability_name": "Marching troop capacity", "ability_id": 12, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 2, "category": 2},
                {"code": 10102012, "name": "Advanced march size boost", "ability_name": "Marching troop capacity", "ability_id": 12, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 3, "category": 2},
                {"code": 10102040, "name": "legendary March size boost", "ability_name": "Marching troop capacity", "ability_id": 12, "duration_hours": 0.5, "duration_seconds": 1800, "grade": 4, "category": 2},
                {"code": 10102041, "name": "mythic march size boost", "ability_name": "Marching troop capacity", "ability_id": 12, "duration_hours": 0.17, "duration_seconds": 600, "grade": 5, "category": 2},
                {"code": 10102017, "name": "Troop attack boost", "ability_name": "Troops Attack", "ability_id": 67, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 2, "category": 2},
                {"code": 10102018, "name": "Advanced Troop attack boost", "ability_name": "Troops Attack", "ability_id": 67, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 3, "category": 2},
                {"code": 10102046, "name": "legendary Troop attack boost", "ability_name": "Troops Attack", "ability_id": 67, "duration_hours": 0.5, "duration_seconds": 1800, "grade": 4, "category": 2},
                {"code": 10102047, "name": "mythic Troop attack boost", "ability_name": "Troops Attack", "ability_id": 67, "duration_hours": 0.17, "duration_seconds": 600, "grade": 5, "category": 2},
                {"code": 10102015, "name": "Troop defense boost", "ability_name": "Troops Defense", "ability_id": 66, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 2, "category": 2},
                {"code": 10102016, "name": "Advanced Troop defense boost", "ability_name": "Troops Defense", "ability_id": 66, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 3, "category": 2},
                {"code": 10102044, "name": "legendary Troop defense boost", "ability_name": "Troops Defense", "ability_id": 66, "duration_hours": 0.5, "duration_seconds": 1800, "grade": 4, "category": 2},
                {"code": 10102045, "name": "mythic Troop defense boost", "ability_name": "Troops Defense", "ability_id": 66, "duration_hours": 0.17, "duration_seconds": 600, "grade": 5, "category": 2},
                {"code": 10102013, "name": "Troop Hp boost", "ability_name": "Troops HP", "ability_id": 65, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 2, "category": 2},
                {"code": 10102014, "name": "Advanced Troop Hp boost", "ability_name": "Troops HP", "ability_id": 65, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 3, "category": 2},
                {"code": 10102042, "name": "legendary Troop Hp boost", "ability_name": "Troops HP", "ability_id": 65, "duration_hours": 0.5, "duration_seconds": 1800, "grade": 4, "category": 2},
                {"code": 10102043, "name": "mythic Troop Hp boost", "ability_name": "Troops HP", "ability_id": 65, "duration_hours": 0.17, "duration_seconds": 600, "grade": 5, "category": 2},
                {"code": 10102019, "name": "Troop speed boost", "ability_name": "Troops Speed", "ability_id": 68, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 2, "category": 2},
                {"code": 10102020, "name": "Advanced Troop speed boost", "ability_name": "Troops Speed", "ability_id": 68, "duration_hours": 1.0, "duration_seconds": 3600, "grade": 3, "category": 2},
                {"code": 10102048, "name": "legendary Troop speed boost", "ability_name": "Troops Speed", "ability_id": 68, "duration_hours": 0.5, "duration_seconds": 1800, "grade": 4, "category": 2},
                {"code": 10102049, "name": "mythic Troop speed boost", "ability_name": "Troops Speed", "ability_id": 68, "duration_hours": 0.17, "duration_seconds": 600, "grade": 5, "category": 2}
            ],
            medium_duration: [
                {"code": 10102001, "name": "Food boost 8hours", "ability_name": "Food Production", "ability_id": 2, "duration_hours": 8.0, "duration_seconds": 28800, "grade": 1, "category": 2},
                {"code": 10102002, "name": "Food boost 1day", "ability_name": "Food Production", "ability_id": 2, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 2, "category": 2},
                {"code": 10102030, "name": "Advanced food boost 1day", "ability_name": "Food Production", "ability_id": 2, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 3, "category": 2},
                {"code": 10102031, "name": "legendary food boost 1day", "ability_name": "Food Production", "ability_id": 2, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 4, "category": 2},
                {"code": 10102009, "name": "Gathering boost 8hours", "ability_name": "Gathering Speed", "ability_id": 35, "duration_hours": 8.0, "duration_seconds": 28800, "grade": 1, "category": 2},
                {"code": 10102010, "name": "Gathering boost 1day", "ability_name": "Gathering Speed", "ability_id": 35, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 2, "category": 2},
                {"code": 10102038, "name": "Advanced gathering boost 1day", "ability_name": "Gathering Speed", "ability_id": 35, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 3, "category": 2},
                {"code": 10102039, "name": "legendary gathering boost 1day", "ability_name": "Gathering Speed", "ability_id": 35, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 4, "category": 2},
                {"code": 10102007, "name": "Gold boost 8hours", "ability_name": "Gold Production", "ability_id": 5, "duration_hours": 8.0, "duration_seconds": 28800, "grade": 1, "category": 2},
                {"code": 10102008, "name": "Gold boost 1day", "ability_name": "Gold Production", "ability_id": 5, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 2, "category": 2},
                {"code": 10102036, "name": "Advanced gold boost 1day", "ability_name": "Gold Production", "ability_id": 5, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 3, "category": 2},
                {"code": 10102037, "name": "legendary gold boost 1day", "ability_name": "Gold Production", "ability_id": 5, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 4, "category": 2},
                {"code": 10102026, "name": "Kingdom Shield 8hours", "ability_name": "King's Shield", "ability_id": 111, "duration_hours": 8.0, "duration_seconds": 28800, "grade": 2, "category": 2},
                {"code": 10102027, "name": "Kingdom Shield 1day", "ability_name": "King's Shield", "ability_id": 111, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 3, "category": 2},
                {"code": 10102003, "name": "Wood boost 8hours", "ability_name": "Lumber Production", "ability_id": 3, "duration_hours": 8.0, "duration_seconds": 28800, "grade": 1, "category": 2},
                {"code": 10102004, "name": "Wood boost 1day", "ability_name": "Lumber Production", "ability_id": 3, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 2, "category": 2},
                {"code": 10102032, "name": "Advanced wood boost 1day", "ability_name": "Lumber Production", "ability_id": 3, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 3, "category": 2},
                {"code": 10102033, "name": "legendary wood boost 1day", "ability_name": "Lumber Production", "ability_id": 3, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 4, "category": 2},
                {"code": 10102021, "name": "Anti Spying 8hours", "ability_name": "Scout limit", "ability_id": 18, "duration_hours": 8.0, "duration_seconds": 28800, "grade": 2, "category": 2},
                {"code": 10102022, "name": "Anti Spying 1day", "ability_name": "Scout limit", "ability_id": 18, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 3, "category": 2},
                {"code": 10102005, "name": "Stone boost 8hours", "ability_name": "Stone Production", "ability_id": 4, "duration_hours": 8.0, "duration_seconds": 28800, "grade": 1, "category": 2},
                {"code": 10102006, "name": "Stone boost 1day", "ability_name": "Stone Production", "ability_id": 4, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 2, "category": 2},
                {"code": 10102034, "name": "Advanced stone boost 1day", "ability_name": "Stone Production", "ability_id": 4, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 3, "category": 2},
                {"code": 10102035, "name": "legendary stone boost 1day", "ability_name": "Stone Production", "ability_id": 4, "duration_hours": 24.0, "duration_seconds": 86400, "grade": 4, "category": 2}
            ],
            long_duration: [
                {"code": 10102024, "name": "Golden hammer 3days", "ability_name": "Additional building queue", "ability_id": 17, "duration_hours": 72.0, "duration_seconds": 259200, "grade": 3, "category": 2},
                {"code": 10102025, "name": "Golden hammer 7days", "ability_name": "Additional building queue", "ability_id": 17, "duration_hours": 168.0, "duration_seconds": 604800, "grade": 4, "category": 2},
                {"code": 10102028, "name": "Kingdom Shield 7days", "ability_name": "King's Shield", "ability_id": 111, "duration_hours": 168.0, "duration_seconds": 604800, "grade": 4, "category": 2}
            ]
        };

        function switchBuffTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('#buff-management .tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('#buff-management .tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function populateBuffManagementConfig(buffConfig) {
            console.log('Loading production boost management config:', buffConfig);

            // Set enabled state
            document.getElementById('buff-management-enabled').checked = buffConfig?.enabled || false;

            // Clear and populate each duration category
            const containers = {
                'short-duration-list': 'short_duration',
                'medium-duration-list': 'medium_duration', 
                'long-duration-list': 'long_duration'
            };

            Object.entries(containers).forEach(([containerId, dataKey]) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                const boosts = PRODUCTION_BOOST_DATA[dataKey] || [];
                
                // Group boosts by ability type
                const groupedBoosts = {};
                boosts.forEach(boost => {
                    if (!groupedBoosts[boost.ability_name]) {
                        groupedBoosts[boost.ability_name] = [];
                    }
                    groupedBoosts[boost.ability_name].push(boost);
                });
                
                // Create cards for each ability group
                Object.entries(groupedBoosts).forEach(([abilityName, abilityBoosts]) => {
                    const card = document.createElement('div');
                    card.className = 'monster-card';
                    
                    // Check if any boost in this group is enabled
                    const savedBoosts = buffConfig?.production_boosts?.[dataKey] || {};
                    const isAnyEnabled = abilityBoosts.some(boost => 
                        savedBoosts[boost.code]?.enabled || false
                    );
                    
                    card.innerHTML = `
                        <div class="monster-header">
                            <i class="fas fa-magic" style="color: #3b82f6;"></i>
                            <span class="monster-name">${abilityName}</span>
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" class="ability-enabled" data-ability="${abilityName}" data-duration="${dataKey}" ${isAnyEnabled ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div style="color: #64748b; font-size: 13px; margin-bottom: 15px;">
                            Available grades: ${abilityBoosts.map(b => `Grade ${b.grade} (${b.duration_hours}h)`).join(', ')}
                        </div>
                        <div class="boost-selection">
                            <label class="input-label">Priority Selection:</label>
                            <select class="dropdown-field boost-priority" data-ability="${abilityName}" data-duration="${dataKey}">
                                <option value="disabled">Disabled</option>
                                ${abilityBoosts.map(boost => {
                                    const selected = savedBoosts[boost.code]?.enabled ? 'selected' : '';
                                    return `<option value="${boost.code}" ${selected}>Grade ${boost.grade} - ${boost.name} (${boost.duration_hours}h)</option>`;
                                }).join('')}
                            </select>
                            <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                                Select which grade to use for this boost type
                            </small>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            });

        }

        function collectBuffManagementFromUI() {
            const result = {
                short_duration: {},
                medium_duration: {}, 
                long_duration: {}
            };
            
            const containers = {
                'short-duration-list': 'short_duration',
                'medium-duration-list': 'medium_duration',
                'long-duration-list': 'long_duration'
            };
            
            Object.entries(containers).forEach(([containerId, dataKey]) => {
                const container = document.getElementById(containerId);
                const dropdowns = container.querySelectorAll('.boost-priority');
                
                dropdowns.forEach(dropdown => {
                    const selectedValue = dropdown.value;
                    if (selectedValue !== 'disabled') {
                        const itemCode = parseInt(selectedValue);
                        const abilityName = dropdown.dataset.ability;
                        
                        // Find the boost data
                        const boostData = PRODUCTION_BOOST_DATA[dataKey].find(b => b.code === itemCode);
                        if (boostData) {
                            result[dataKey][itemCode] = {
                                enabled: true,
                                name: boostData.name,
                                ability_name: boostData.ability_name,
                                duration_hours: boostData.duration_hours,
                                grade: boostData.grade,
                                min_duration_minutes: 20 // Default minimum duration
                            };
                        }
                    }
                });
            });
            
            return result;
        }


        function populateAllianceActivitiesConfig(config) {
            console.log('Loading alliance activities config:', config);

            // Alliance Help All
            const helpConfig = config.help_all || {};
            document.getElementById('alliance-help-enabled').checked = helpConfig.enabled !== false;
            document.getElementById('alliance-help-interval').value = helpConfig.interval_minutes || 5;

            // Alliance Gift Claim
            const giftConfig = config.gift_claim || {};
            document.getElementById('alliance-gift-enabled').checked = giftConfig.enabled !== false;
            document.getElementById('alliance-gift-interval').value = giftConfig.interval_minutes || 30;

            // Alliance Research Donate
            const researchConfig = config.research_donate || {};
            document.getElementById('alliance-research-enabled').checked = researchConfig.enabled !== false;
            document.getElementById('alliance-research-interval').value = researchConfig.interval_minutes || 60;

            // Alliance Shop Auto-Buy
            const shopConfig = config.shop_auto_buy || {};
            document.getElementById('alliance-shop-enabled').checked = shopConfig.enabled !== false;
            document.getElementById('alliance-shop-interval').value = shopConfig.interval_minutes || 120;

            // Caravan Auto-Buy
            const caravanConfig = config.caravan_auto_buy || {};
            document.getElementById('caravan-auto-buy-enabled').checked = caravanConfig.enabled !== false;
            document.getElementById('caravan-interval').value = caravanConfig.interval_minutes || 180;

            // Load existing shop and caravan item configurations
            loadAllianceShopConfig();
            loadCaravanConfig();
        }

        function populateSkillsConfig(config) {
            console.log('Loading skills config:', config);

            // Set enabled state
            document.getElementById('skills-enabled').checked = config.enabled || false;

            // Load skin change settings
            document.getElementById('skills-skin-change-enabled').checked = config.skin_change_enabled || false;
            document.getElementById('skills-skin-item-id').value = config.skin_item_id || '';
            document.getElementById('skills-skin-item-id-2').value = config.skin_item_id_2 || '';

            // Load treasure page settings
            document.getElementById('skills-treasure-page-1').value = config.treasure_page_1 || 1;
            document.getElementById('skills-treasure-page-2').value = config.treasure_page_2 || 2;

            // Set individual skill checkboxes based on config
            const skill10001 = document.getElementById('skill-10001-enabled');
            const skill10002 = document.getElementById('skill-10002-enabled');
            
            // Set skill states based on config
            if (config.skills && config.skills.length > 0) {
                config.skills.forEach(skill => {
                    if (skill.code === 10001 && skill10001) {
                        skill10001.checked = skill.enabled;
                    } else if (skill.code === 10002 && skill10002) {
                        skill10002.checked = skill.enabled;
                    }
                });
            } else {
                // Set default states for skills if none configured
                if (skill10001) skill10001.checked = false;
                if (skill10002) skill10002.checked = false;
            }
        }

        function createSkillCard(skill, enabled) {
            const card = document.createElement('div');
            card.className = 'monster-card';

            card.innerHTML = `
                <div class="monster-header">
                    <input type="checkbox" class="monster-checkbox" ${enabled ? 'checked' : ''} data-skill-code="${skill.code}">
                    <span class="monster-name">${skill.name}</span>
                    <small style="color: #64748b; font-size: 12px; margin-left: auto;">Code: ${skill.code}</small>
                </div>
            `;

            return card;
        }

        function populateTreasureConfig(treasureConfig) {
            console.log('Loading treasure config:', treasureConfig);

            // Set enabled state
            document.getElementById('treasure-enabled').checked = treasureConfig?.enabled || false;

            // Set treasure page
            const treasurePageSelect = document.getElementById('treasure-page');
            treasurePageSelect.value = treasureConfig?.page || 1;

            // Set skin change enabled state
            document.getElementById('treasure-skin-change-enabled').checked = treasureConfig?.skin_change_enabled || false;

            // Set skin item ID
            document.getElementById('treasure-skin-item-id').value = treasureConfig?.skin_item_id || '';

            // Set skin change interval
            document.getElementById('treasure-skin-change-interval').value = treasureConfig?.skin_change_interval || 60;
        }

        function collectSkillsFromUI() {
            const skills = [];
            
            // Collect from individual skill checkboxes
            const skill10001 = document.getElementById('skill-10001-enabled');
            const skill10002 = document.getElementById('skill-10002-enabled');
            
            if (skill10001) {
                skills.push({
                    "code": 10001,
                    "enabled": skill10001.checked
                });
            }
            
            if (skill10002) {
                skills.push({
                    "code": 10002,
                    "enabled": skill10002.checked
                });
            }

            return skills;
        }

        function populateDsavipConfig(jobs) {
            console.log('Loading DSA VIP config');

            // Find DSA VIP chest claim job
            const dsavipJob = jobs.find(job => job.name === 'dsavip_chest_claim');

            // Set DSA VIP chest claim toggle
            const dsavipChestCheckbox = document.getElementById('dsavip-chest-enabled');
            if (dsavipChestCheckbox) {
                dsavipChestCheckbox.checked = dsavipJob ? dsavipJob.enabled : false;
            }

            // Set DSA VIP job enabled toggle  
            const dsavipJobCheckbox = document.getElementById('dsavip-job-enabled');
            if (dsavipJobCheckbox) {
                dsavipJobCheckbox.checked = dsavipJob ? dsavipJob.enabled : false;
            }
        }

        function populateSettingsConfig(jobs, threads) {
            console.log('Loading settings config - jobs:', jobs);
            console.log('Loading settings config - threads:', threads);

            // Populate jobs
            const jobsList = document.getElementById('jobs-list');
            if (jobsList) {
                jobsList.innerHTML = '';

                const jobDescriptions = {
                    'hospital_recover': 'Automatically heal wounded troops in the hospital',
                    'wall_repair': 'Automatically repair wall damage',
                    'mail_claim': 'Automatically claim mail rewards',
                    'caravan_farmer': 'Manage caravan trading activities',
                    'use_resource_in_item_list': 'Use resource items from inventory',
                    'vip_chest_claim': 'Claim VIP chest rewards',
                    'harvester': 'Harvest resources from resource nodes',
                    'socf_thread': 'Scan and share objects/monsters found nearby',
                    'dsavip_chest_claim': 'Claim DSA VIP chest rewards'
                };

                jobs.forEach(job => {
                    // Skip DSA VIP chest claim and alliance farmer as they have their own dedicated tabs
                    if (job.name === 'dsavip_chest_claim' || job.name === 'alliance_farmer') {
                        return;
                    }

                    const jobItem = document.createElement('div');
                    jobItem.className = 'job-item';
                    jobItem.innerHTML = `
                        <div>
                            <div class="job-name">${job.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                            <div class="job-description">${jobDescriptions[job.name] || 'Job configuration'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" ${job.enabled ? 'checked' : ''} onchange="toggleJob('${job.name}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    `;
                    jobsList.appendChild(jobItem);
                });
            }

            // Alliance farmer features are now handled in the dedicated Alliance Activities tab
            // This section has been removed to eliminate duplication

            // Populate threads
            const threadsList = document.getElementById('threads-list');
            if (threadsList) {
                threadsList.innerHTML = '';

                const threadDescriptions = {
                    'free_chest_farmer_thread': 'Automatically claim free chests and daily rewards',
                    'quest_monitor_thread': 'Monitor and complete available quests',
                    'building_farmer_thread': 'Automatically upgrade buildings',
                    'academy_farmer_thread': 'Automatically conduct research in academy',
                    'train_troop_thread': 'Automatically train troops'
                };

                threads.forEach(thread => {
                    const threadItem = document.createElement('div');
                    threadItem.className = 'thread-item';
                    threadItem.innerHTML = `
                        <div>
                            <div class="thread-name">${thread.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                            <div class="thread-description">${threadDescriptions[thread.name] || 'Thread configuration'}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" ${thread.enabled ? 'checked' : ''} onchange="toggleThread('${thread.name}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    `;
                    threadsList.appendChild(threadItem);
                });
            }
        }

        function toggleJob(jobName, enabled) {
            console.log(`Toggling job: ${jobName} to ${enabled}`);

            // Update the job in fullConfigData
            if (!fullConfigData.main) {
                fullConfigData.main = {};
            }
            if (!fullConfigData.main.jobs) {
                fullConfigData.main.jobs = [];
            }

            // Find and update the job
            let job = fullConfigData.main.jobs.find(j => j.name === jobName);
            if (job) {
                job.enabled = enabled;
            } else {
                // Create new job if it doesn't exist
                const defaultJob = {
                    name: jobName,
                    enabled: enabled,
                    interval: { start: 120, end: 200 }
                };
                fullConfigData.main.jobs.push(defaultJob);
            }

            // Also update toggles structure for consistency
            if (!fullConfigData.toggles) {
                fullConfigData.toggles = {};
            }
            if (!fullConfigData.toggles.jobs) {
                fullConfigData.toggles.jobs = {};
            }
            fullConfigData.toggles.jobs[jobName] = enabled;

            console.log(`Updated job ${jobName} enabled status to ${enabled}`);
        }

        function toggleThread(threadName, enabled) {
            console.log(`Toggling thread: ${threadName} to ${enabled}`);

            // Update the thread in fullConfigData
            if (!fullConfigData.main) {
                fullConfigData.main = {};
            }
            if (!fullConfigData.main.threads) {
                fullConfigData.main.threads = [];
            }

            // Find and update the thread
            let thread = fullConfigData.main.threads.find(t => t.name === threadName);
            if (thread) {
                thread.enabled = enabled;
            } else {
                // Create new thread if it doesn't exist
                const defaultThread = {
                    name: threadName,
                    enabled: enabled
                };
                fullConfigData.main.threads.push(defaultThread);
            }

            // Also update toggles structure for consistency
            if (!fullConfigData.toggles) {
                fullConfigData.toggles = {};
            }
            if (!fullConfigData.toggles.threads) {
                fullConfigData.toggles.threads = {};
            }
            fullConfigData.toggles.threads[threadName] = enabled;

            console.log(`Updated thread ${threadName} enabled status to ${enabled}`);
        }

        function toggleAllianceFarmerFeature(featureName, enabled) {
            console.log(`Toggling alliance farmer feature: ${featureName} to ${enabled}`);

            // Update the alliance farmer job kwargs in fullConfigData
            if (!fullConfigData.main) {
                fullConfigData.main = {};
            }
            if (!fullConfigData.main.jobs) {
                fullConfigData.main.jobs = [];
            }

            // Find alliance farmer job
            let allianceJob = fullConfigData.main.jobs.find(j => j.name === 'alliance_farmer');
            if (allianceJob) {
                if (!allianceJob.kwargs) {
                    allianceJob.kwargs = {};
                }
                allianceJob.kwargs[featureName] = enabled;
            } else {
                // Create alliance farmer job if it doesn't exist
                const newAllianceJob = {
                    name: 'alliance_farmer',
                    enabled: true,
                    interval: { start: 120, end: 200 },
                    kwargs: {
                        [featureName]: enabled
                    }
                };
                fullConfigData.main.jobs.push(newAllianceJob);
            }

            console.log(`Updated alliance farmer feature ${featureName} to ${enabled}`);
        }

        function createCommonTroopItem(troop) {
            const troopItem = document.createElement('div');
            troopItem.className = 'troop-item';
            troopItem.innerHTML = `
                <select class="troop-select" data-troop-code="${troop.code}">
                    <option value="${troop.code}" selected>${troop.name || getTroopNameByCode(troop.code)}</option>
                    <!-- Tier 6 Troops -->
                    <option value="50100106">Paladin (Tier 6 Infantry)</option>
                    <option value="50100107">Destroyer (Tier 6 Infantry)</option>
                    <option value="50100206">Marksman (Tier 6 Ranged)</option>
                    <option value="50100207">Musketeer (Tier 6 Ranged)</option>
                    <option value="50100306">Marauder (Tier 6 Cavalry)</option>
                    <option value="50100307">Valkyrie (Tier 6 Cavalry)</option>
                    <!-- Tier 5 Troops -->
                    <option value="50100105">Crusader (Tier 5 Infantry)</option>
                    <option value="50100205">Sniper (Tier 5 Ranged)</option>
                    <option value="50100305">Dragoon (Tier 5 Cavalry)</option>
                    <!-- Tier 4 Troops -->
                    <option value="50100104">Guardian (Tier 4 Infantry)</option>
                    <option value="50100204">Crossbow Man (Tier 4 Ranged)</option>
                    <option value="50100304">Iron Cavalry (Tier 4 Cavalry)</option>
                    <!-- Tier 3 Troops -->
                    <option value="50100103">Knight (Tier 3 Infantry)</option>
                    <option value="50100203">Ranger (Tier 3 Ranged)</option>
                    <option value="50100303">Heavy Cavalry (Tier 3 Cavalry)</option>
                </select>
                <input type="number" class="troop-amount-input" value="${troop.amount || 0}" min="0" placeholder="Amount">
                <button class="btn btn-danger" onclick="removeTroopItem(this)">Remove</button>
            `;
            return troopItem;
        }

        function addCommonTroop() {
            const commonTroopsList = document.getElementById('common-troops-list');
            if (commonTroopsList) {
                const newTroop = {
                    code: 50100305,
                    name: 'Dragoon (Tier 5 Cavalry)',
                    amount: 0
                };
                const currentIndex = commonTroopsList.children.length;
                const troopItem = createCommonTroopItem(newTroop, currentIndex);
                commonTroopsList.appendChild(troopItem);
            }
        }

        // Make addCommonTroop globally available
        window.addCommonTroop = addCommonTroop;

        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function createCommonTroopItem(troop, index) {
            const troopDiv = document.createElement('div');
            troopDiv.className = 'troop-item';
            troopDiv.innerHTML = `
                <select class="troop-select" data-troop-code="${troop.code}" onchange="updateTroopData(this)">
                    <option value="${troop.code}" selected>${troop.name || getTroopNameByCode(troop.code)}</option>
                    <optgroup label="Tier 6 Troops">
                        <option value="50100106">Paladin (Tier 6 Infantry)</option>
                        <option value="50100107">Destroyer (Tier 6 Infantry)</option>
                        <option value="50100206">Marksman (Tier 6 Ranged)</option>
                        <option value="50100207">Musketeer (Tier 6 Ranged)</option>
                        <option value="50100306">Marauder (Tier 6 Cavalry)</option>
                        <option value="50100307">Valkyrie (Tier 6 Cavalry)</option>
                    </optgroup>
                    <optgroup label="Tier 5 Troops">
                        <option value="50100105">Crusader (Tier 5 Infantry)</option>
                        <option value="50100205">Sniper (Tier 5 Ranged)</option>
                        <option value="50100305">Dragoon (Tier 5 Cavalry)</option>
                    </optgroup>
                    <optgroup label="Tier 4 Troops">
                        <option value="50100104">Guardian (Tier 4 Infantry)</option>
                        <option value="50100204">Crossbow Man (Tier 4 Ranged)</option>
                        <option value="50100304">Iron Cavalry (Tier 4 Cavalry)</option>
                    </optgroup>
                    <optgroup label="Tier 3 Troops">
                        <option value="50100103">Knight (Tier 3 Infantry)</option>
                        <option value="50100203">Ranger (Tier 3 Ranged)</option>
                        <option value="50100303">Heavy Cavalry (Tier 3 Cavalry)</option>
                    </optgroup>
                </select>
                <input type="number" class="troop-amount-input" value="${troop.amount || 0}" min="0" placeholder="Amount">
                <button class="btn btn-danger" onclick="removeTroopItem(this)" style="flex-shrink: 0;">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            return troopDiv;
        }

        function updateTroopData(selectElement) {
            // Update the data-troop-code attribute when selection changes
            selectElement.setAttribute('data-troop-code', selectElement.value);
        }

        function getTroopNameByCode(code) {
            const troopNames = {
                50100106: "Paladin (Tier 6 Infantry)",
                50100107: "Destroyer (Tier 6 Infantry)",
                50100206: "Marksman (Tier 6 Ranged)",
                50100207: "Musketeer (Tier 6 Ranged)",
                50100306: "Marauder (Tier 6 Cavalry)",
                50100307: "Valkyrie (Tier 6 Cavalry)",
                50100105: "Crusader (Tier 5 Infantry)",
                50100205: "Sniper (Tier 5 Ranged)",
                50100305: "Dragoon (Tier 5 Cavalry)",
                50100104: "Guardian (Tier 4 Infantry)",
                50100204: "Crossbow Man (Tier 4 Ranged)",
                50100304: "Iron Cavalry (Tier 4 Cavalry)",
                50100103: "Knight (Tier 3 Infantry)",
                50100203: "Ranger (Tier 3 Ranged)",
                50100303: "Heavy Cavalry (Tier 3 Cavalry)"
            };
            return troopNames[code] || `Unknown Troop (${code})`;
        }

        function collectSettingsFromUI() {
            console.log('Collecting settings from UI');

            // Collect job toggles
            const jobCheckboxes = document.querySelectorAll('#jobs-list input[type="checkbox"]');
            jobCheckboxes.forEach(checkbox => {
                const match = checkbox.getAttribute('onchange').match(/toggleJob\('([^']+)'/);
                if (!match) return;
                const jobName = match[1];
                toggleJob(jobName, checkbox.checked);
            });

            // Collect thread toggles
            const threadCheckboxes = document.querySelectorAll('#threads-list input[type="checkbox"]');
            threadCheckboxes.forEach(checkbox => {
                const match = checkbox.getAttribute('onchange').match(/toggleThread\('([^']+)'/);
                if (!match) return;
                const threadName = match[1];
                toggleThread(threadName, checkbox.checked);
            });

            // Alliance activities are now handled in the dedicated Alliance Activities tab

            console.log('Settings collection completed');
        }

        // Alliance Shop Configuration Functions
        let availableShopItems = {};
        let currentShopConfig = { enabled: false, items: [] };

        async function loadAllianceShopItems() {
            try {
                const response = await fetch('/api/alliance_shop/items');
                const data = await response.json();
                
                if (data.success) {
                    availableShopItems = data.categories;
                    showNotification('Available items loaded successfully', 'success');
                } else {
                    showNotification('Failed to load available items: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error loading shop items: ' + error.message, 'error');
            }
        }

        async function loadAllianceShopConfig() {
            try {
                const configFile = getCurrentConfigFile();
                const response = await fetch(`/api/alliance_shop/config?config_file=${encodeURIComponent(configFile)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentShopConfig = data.config;
                    updateShopConfigDisplay();
                } else {
                    console.warn('No shop config found, using defaults');
                    currentShopConfig = { enabled: false, items: [] };
                    updateShopConfigDisplay();
                }
            } catch (error) {
                console.error('Error loading shop config:', error);
                currentShopConfig = { enabled: false, items: [] };
                updateShopConfigDisplay();
            }
        }

        function updateShopConfigDisplay() {
            // No longer need to manage toggles since it's integrated in Alliance Activities
            renderShopItemsList();
        }

        function toggleShopBuying(enabled) {
            // This function is no longer needed since shop configuration is integrated
            // in Alliance Activities tab with direct controls
            currentShopConfig.enabled = enabled;
            
            if (enabled && Object.keys(availableShopItems).length === 0) {
                loadAllianceShopItems();
            }
        }

        function renderShopItemsList() {
            const itemsList = document.getElementById('alliance-shop-items-list');
            itemsList.innerHTML = '';
            
            if (!currentShopConfig.items || currentShopConfig.items.length === 0) {
                itemsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-shopping-cart" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="margin: 0;">No items configured for auto-buying</p>
                        <p style="margin: 4px 0 0 0; font-size: 12px;">Click "Add Item" to get started</p>
                    </div>
                `;
                return;
            }
            
            // Sort items by priority but keep track of original indices
            const sortedItems = currentShopConfig.items
                .map((item, originalIndex) => ({ item, originalIndex }))
                .sort((a, b) => (a.item.priority || 999) - (b.item.priority || 999));
            
            sortedItems.forEach(({ item, originalIndex }) => {
                const itemElement = createShopItemElement(item, originalIndex);
                itemsList.appendChild(itemElement);
            });
        }

        function createShopItemElement(item, index) {
            const itemElement = document.createElement('div');
            itemElement.className = 'shop-item-config';
            itemElement.style.cssText = `
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 12px;
                position: relative;
            `;
            
            // Find item info from available items
            let itemInfo = { name: `Item ${item.item_code}`, description: '', category: 'Unknown' };
            Object.values(availableShopItems).forEach(category => {
                const found = category.find(i => i.item_code === item.item_code);
                if (found) itemInfo = found;
            });
            
            itemElement.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                            ${itemInfo.name}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${itemInfo.description} • Code: ${item.item_code}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label class="toggle-switch" style="margin: 0;">
                            <input type="checkbox" ${item.enabled ? 'checked' : ''} 
                                   onchange="updateShopItem(${index}, 'enabled', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <button onclick="removeShopItem(${index})" 
                                style="background: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--text-primary);">
                            Priority
                        </label>
                        <input type="number" min="1" max="999" value="${item.priority || 1}" 
                               onchange="updateShopItem(${index}, 'priority', parseInt(this.value))"
                               style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--text-primary);">
                            Min Buy
                        </label>
                        <input type="number" min="1" value="${item.min_buy || 1}" 
                               onchange="updateShopItem(${index}, 'min_buy', parseInt(this.value))"
                               style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px; color: var(--text-primary);">
                            Max Buy
                        </label>
                        <input type="number" min="1" value="${item.max_buy || 999999}" 
                               onchange="updateShopItem(${index}, 'max_buy', parseInt(this.value))"
                               style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                </div>
            `;
            
            return itemElement;
        }

        function addShopItem() {
            if (Object.keys(availableShopItems).length === 0) {
                showNotification('Please load available items first', 'warning');
                return;
            }
            
            // Create item selection modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary);">Add Shop Item</h3>
                    <button onclick="this.closest('.modal').remove()" 
                            style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary);">
                        ×
                    </button>
                </div>
                
                <div id="item-categories">
                    ${Object.entries(availableShopItems).map(([categoryName, items]) => `
                        <div style="margin-bottom: 20px;">
                            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                ${categoryName}
                            </h4>
                            <div style="display: grid; gap: 8px;">
                                ${items.map(item => `
                                    <div onclick="selectShopItem(${item.item_code}, '${item.name}', ${item.default_priority})" 
                                         style="padding: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                                         onmouseover="this.style.borderColor = 'var(--accent-color)'"
                                         onmouseout="this.style.borderColor = 'var(--border-color)'">
                                        <div style="font-weight: 500; color: var(--text-primary);">${item.name}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${item.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function selectShopItem(itemCode, itemName, defaultPriority) {
            // Check if item already exists
            const existingIndex = currentShopConfig.items.findIndex(item => item.item_code === itemCode);
            if (existingIndex !== -1) {
                showNotification(`${itemName} is already in the list`, 'warning');
                document.querySelector('.modal').remove();
                return;
            }
            
            // Add new item
            const newItem = {
                item_code: itemCode,
                enabled: true,
                priority: defaultPriority || 1,
                min_buy: 1,
                max_buy: 999999
            };
            
            currentShopConfig.items.push(newItem);
            renderShopItemsList();
            document.querySelector('.modal').remove();
            showNotification(`${itemName} added to shop auto-buy list`, 'success');
        }

        function updateShopItem(index, field, value) {
            if (currentShopConfig && 
                currentShopConfig.items && 
                index >= 0 && 
                index < currentShopConfig.items.length && 
                currentShopConfig.items[index]) {
                currentShopConfig.items[index][field] = value;
            } else {
                console.error('Invalid updateShopItem call:', { index, field, value, itemsLength: currentShopConfig?.items?.length });
            }
        }

        function removeShopItem(index) {
            if (currentShopConfig && 
                currentShopConfig.items && 
                index >= 0 && 
                index < currentShopConfig.items.length) {
                currentShopConfig.items.splice(index, 1);
                renderShopItemsList();
                showNotification('Item removed from shop auto-buy list', 'info');
            } else {
                console.error('Invalid removeShopItem call:', { index, itemsLength: currentShopConfig?.items?.length });
            }
        }

        async function saveAllianceShopConfig() {
            try {
                const configFile = getCurrentConfigFile();
                const response = await fetch('/api/alliance_shop/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config_file: configFile,
                        shop_config: currentShopConfig
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    return true;
                } else {
                    throw new Error(data.error || 'Failed to save shop config');
                }
            } catch (error) {
                console.error('Error saving shop config:', error);
                throw error;
            }
        }

        // Extend the existing saveConfig function to include shop configuration
        const originalSaveConfig = window.saveConfig;
        window.saveConfig = async function(tabName) {
            try {
                // Save shop config if it's enabled or has items
                if (currentShopConfig.enabled || (currentShopConfig.items && currentShopConfig.items.length > 0)) {
                    await saveAllianceShopConfig();
                }
                
                // Call original save function
                return originalSaveConfig(tabName);
            } catch (error) {
                showNotification('Error saving alliance shop configuration: ' + error.message, 'error');
                return false;
            }
        };

        // Add shop functions to global scope
        window.loadAllianceShopItems = loadAllianceShopItems;
        window.toggleShopBuying = toggleShopBuying;
        window.addShopItem = addShopItem;
        window.selectShopItem = selectShopItem;
        window.updateShopItem = updateShopItem;
        window.removeShopItem = removeShopItem;
        window.loadAllianceShopConfig = loadAllianceShopConfig;

        // ===============================
        // CARAVAN CONFIGURATION FUNCTIONS
        // ===============================
        
        let currentCaravanConfig = {
            enabled: false,
            items: []
        };

        async function loadCaravanItems() {
            try {
                const response = await fetch('/api/caravan/items');
                const data = await response.json();
                
                if (data.success) {
                    window.caravanItemsData = data.categories;
                    showNotification('Caravan items loaded successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to load caravan items');
                }
            } catch (error) {
                console.error('Error loading caravan items:', error);
                showNotification('Error loading caravan items: ' + error.message, 'error');
            }
        }

        function toggleCaravanBuying(enabled) {
            currentCaravanConfig.enabled = enabled;
            // No longer need to manage toggles since it's integrated in Alliance Activities
        }

        function addCaravanItem() {
            if (!window.caravanItemsData) {
                showNotification('Please load caravan items first', 'warning');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;

            // Generate category options
            let categoryOptions = '';
            for (const category in window.caravanItemsData) {
                categoryOptions += `<option value="${category}">${category}</option>`;
            }

            modal.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; color: var(--text-primary);">Add Caravan Item</h3>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Category:</label>
                        <select id="caravan-category-select" onchange="updateCaravanItemOptions()" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            <option value="">Select Category</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-primary);">Item:</label>
                        <select id="caravan-item-select" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            <option value="">Select Item</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; color: var(--text-primary); font-size: 12px;">Priority (1-10):</label>
                            <input type="number" id="caravan-priority" min="1" max="10" value="1" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; color: var(--text-primary); font-size: 12px;">Min Buy:</label>
                            <input type="number" id="caravan-min-buy" min="1" value="1" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; color: var(--text-primary); font-size: 12px;">Max Buy:</label>
                            <input type="number" id="caravan-max-buy" min="1" value="999999" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="padding: 8px 16px; background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="saveCaravanItem()" style="padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">Add Item</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        function updateCaravanItemOptions() {
            const categorySelect = document.getElementById('caravan-category-select');
            const itemSelect = document.getElementById('caravan-item-select');
            const category = categorySelect.value;

            itemSelect.innerHTML = '<option value="">Select Item</option>';

            if (category && window.caravanItemsData[category]) {
                window.caravanItemsData[category].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.item_code;
                    option.textContent = item.name;
                    option.title = item.description;
                    itemSelect.appendChild(option);
                });
            }
        }

        function saveCaravanItem() {
            const itemCode = parseInt(document.getElementById('caravan-item-select').value);
            const priority = parseInt(document.getElementById('caravan-priority').value);
            const minBuy = parseInt(document.getElementById('caravan-min-buy').value);
            const maxBuy = parseInt(document.getElementById('caravan-max-buy').value);

            if (!itemCode) {
                showNotification('Please select an item', 'warning');
                return;
            }

            // Check if item already exists
            if (currentCaravanConfig.items.some(item => item.item_code === itemCode)) {
                showNotification('Item already exists in configuration', 'warning');
                return;
            }

            // Find item details
            let itemDetails = null;
            for (const category in window.caravanItemsData) {
                const found = window.caravanItemsData[category].find(item => item.item_code === itemCode);
                if (found) {
                    itemDetails = found;
                    break;
                }
            }

            const newItem = {
                item_code: itemCode,
                enabled: true,
                priority: priority,
                min_buy: minBuy,
                max_buy: maxBuy,
                name: itemDetails ? itemDetails.name : `Item ${itemCode}`,
                description: itemDetails ? itemDetails.description : '',
                category: itemDetails ? itemDetails.category : 'Other'
            };

            currentCaravanConfig.items.push(newItem);
            updateCaravanItemsList();
            document.querySelector('.modal-overlay').remove();
            showNotification('Caravan item added successfully!', 'success');
        }

        function updateCaravanItemsList() {
            const container = document.getElementById('caravan-items-list');
            if (!container) return;

            if (currentCaravanConfig.items.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No caravan items configured. Click "Add Item" to get started.</p>';
                return;
            }

            container.innerHTML = currentCaravanConfig.items.map(item => `
                <div style="display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${item.name}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">${item.description}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            Priority: ${item.priority} | Min: ${item.min_buy} | Max: ${item.max_buy} | Category: ${item.category}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label class="toggle-switch" style="transform: scale(0.8);">
                            <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleCaravanItem(${item.item_code}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <button onclick="editCaravanItem(${item.item_code})" style="padding: 4px 8px; font-size: 10px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Edit</button>
                        <button onclick="removeCaravanItem(${item.item_code})" style="padding: 4px 8px; font-size: 10px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleCaravanItem(itemCode, enabled) {
            const item = currentCaravanConfig.items.find(item => item.item_code === itemCode);
            if (item) {
                item.enabled = enabled;
            }
        }

        function editCaravanItem(itemCode) {
            const item = currentCaravanConfig.items.find(item => item.item_code === itemCode);
            if (!item) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; width: 90%; max-width: 400px;">
                    <h3 style="margin: 0 0 20px 0; color: var(--text-primary);">Edit ${item.name}</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; color: var(--text-primary); font-size: 12px;">Priority (1-10):</label>
                            <input type="number" id="edit-caravan-priority" min="1" max="10" value="${item.priority}" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; color: var(--text-primary); font-size: 12px;">Min Buy:</label>
                            <input type="number" id="edit-caravan-min-buy" min="1" value="${item.min_buy}" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; color: var(--text-primary); font-size: 12px;">Max Buy:</label>
                            <input type="number" id="edit-caravan-max-buy" min="1" value="${item.max_buy}" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="padding: 8px 16px; background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="updateCaravanItem(${itemCode})" style="padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer;">Update</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function updateCaravanItem(itemCode) {
            const item = currentCaravanConfig.items.find(item => item.item_code === itemCode);
            if (!item) return;

            item.priority = parseInt(document.getElementById('edit-caravan-priority').value);
            item.min_buy = parseInt(document.getElementById('edit-caravan-min-buy').value);
            item.max_buy = parseInt(document.getElementById('edit-caravan-max-buy').value);

            updateCaravanItemsList();
            document.querySelector('.modal-overlay').remove();
            showNotification('Caravan item updated successfully!', 'success');
        }

        function removeCaravanItem(itemCode) {
            if (confirm('Are you sure you want to remove this caravan item?')) {
                currentCaravanConfig.items = currentCaravanConfig.items.filter(item => item.item_code !== itemCode);
                updateCaravanItemsList();
                showNotification('Caravan item removed successfully!', 'success');
            }
        }

        async function loadCaravanConfig() {
            try {
                const configFile = getCurrentConfigFile();
                const response = await fetch(`/api/caravan/config?config_file=${encodeURIComponent(configFile)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentCaravanConfig = data.config || { enabled: false, items: [] };
                    
                    // Update UI - caravan config is now integrated in Alliance Activities tab
                    // The checkbox state is managed by the Alliance Activities configuration
                    
                    updateCaravanItemsList();
                }
            } catch (error) {
                console.error('Error loading caravan config:', error);
            }
        }

        async function saveCaravanConfig() {
            try {
                const configFile = getCurrentConfigFile();
                const response = await fetch('/api/caravan/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config_file: configFile,
                        caravan_config: currentCaravanConfig
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    return true;
                } else {
                    throw new Error(data.error || 'Failed to save caravan config');
                }
            } catch (error) {
                showNotification('Error saving caravan configuration: ' + error.message, 'error');
                return false;
            }
        }

        // Extend saveConfig to include caravan config saving
        const previousSaveConfig = window.saveConfig;
        window.saveConfig = async function(tabName) {
            try {
                // Save caravan config if it's enabled or has items
                if (currentCaravanConfig.enabled || (currentCaravanConfig.items && currentCaravanConfig.items.length > 0)) {
                    await saveCaravanConfig();
                }
                
                // Call previous save function (which already includes shop config)
                return previousSaveConfig(tabName);
            } catch (error) {
                showNotification('Error saving configurations: ' + error.message, 'error');
                return false;
            }
        };

        // Add caravan functions to global scope
        window.loadCaravanItems = loadCaravanItems;
        window.toggleCaravanBuying = toggleCaravanBuying;
        window.addCaravanItem = addCaravanItem;
        window.updateCaravanItemOptions = updateCaravanItemOptions;
        window.saveCaravanItem = saveCaravanItem;
        window.toggleCaravanItem = toggleCaravanItem;
        window.editCaravanItem = editCaravanItem;
        window.updateCaravanItem = updateCaravanItem;
        window.removeCaravanItem = removeCaravanItem;
        window.loadCaravanConfig = loadCaravanConfig;
    </script>
</body>

</html>